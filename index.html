<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FabricateHub | Marketplace de Fabricação</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d32f2f;
            --primary-dark: #b71c1c;
            --primary-light: #ff6659;
            --secondary: #455a64;
            --accent: #ff9800;
            --danger: #c62828;
            --warning: #ff8f00;
            --dark: #212121;
            --dark-gray: #424242;
            --gray: #757575;
            --light-gray: #e0e0e0;
            --light: #f5f5f5;
            --border-radius: 4px;
            --box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
            --box-shadow-heavy: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --industrial-border: 1px solid rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
            min-height: 100vh;
        }

        h1, h2, h3, h4 {
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
            margin-bottom: 1rem;
            letter-spacing: 0.5px;
        }

        /* ===== ESTILOS DE LOGIN ===== */
        #auth-page {
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }

        #auth-page.active {
            display: flex;
        }

        #auth-page:not(.active) {
            display: none;
        }

        .auth-container {
            background: #1a1a1a;
            border-radius: 8px;
            box-shadow: var(--box-shadow-heavy);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 1fr;
            border: 1px solid #333;
        }

        @media (max-width: 768px) {
            .auth-container {
                grid-template-columns: 1fr;
            }
        }

        .auth-side {
            padding: 60px 50px;
            overflow-y: auto;
            max-height: 100vh;
        }

        @media (max-width: 768px) {
            .auth-side {
                padding: 40px 30px;
            }
        }

        .auth-side.left {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .auth-side.left {
                display: none;
            }
        }

        .auth-side.left::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            }

        .auth-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            font-family: 'Oswald', sans-serif;
            position: relative;
            z-index: 2;
        }

        .auth-logo i {
            font-size: 2.5rem;
            color: #ffccbc;
        }

        .features {
            margin-top: 40px;
            position: relative;
            z-index: 2;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            border-left: 3px solid #ffccbc;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ffccbc;
        }

        .form-container-auth {
            display: none;
        }

        .form-container-auth.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-header {
            margin-bottom: 30px;
        }

        .form-header h3 {
            font-size: 1.8rem;
            color: white;
            margin-bottom: 10px;
            font-family: 'Oswald', sans-serif;
        }

        .form-header p {
            color: #bdbdbd;
        }

        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: 'Roboto', sans-serif;
            transition: var(--transition);
            color: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2);
        }

        .password-input {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.1rem;
        }

        .conditional-fields {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--primary);
        }

        .conditional-fields.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .form-checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .checkbox-group-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (max-width: 480px) {
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
        }

        .file-format-options {
            margin-top: 15px;
        }

        .file-format-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: var(--transition);
        }

        .file-format-option:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary-light);
        }

        .file-format-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .file-format-info {
            display: flex;
            flex-direction: column;
        }

        .file-format-title {
            font-weight: 500;
            color: white;
        }

        .file-format-desc {
            font-size: 0.85rem;
            color: var(--light-gray);
        }

        .btn {
            padding: 14px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: 'Oswald', sans-serif;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary-dark);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-large {
            padding: 14px 28px;
            font-size: 1.1rem;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
            border: 1px solid #37474f;
        }

        .btn-secondary:hover {
            background-color: #37474f;
        }

        .btn-accent {
            background-color: var(--accent);
            color: white;
            border: 1px solid #f57c00;
        }

        .btn-accent:hover {
            background-color: #f57c00;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
            border: 1px solid #b71c1c;
        }

        .btn-danger:hover {
            background-color: #b71c1c;
        }

        .btn-social {
            padding: 12px;
            border: 1px solid #444;
            background: #2c2c2c;
            color: white;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-social:hover {
            border-color: var(--primary);
            background: rgba(211, 47, 47, 0.1);
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 25px 0;
            color: var(--gray);
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #444;
        }

        .form-footer {
            text-align: center;
            margin-top: 25px;
            color: var(--gray);
        }

        .form-footer a {
            color: var(--primary-light);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .alert {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid;
        }

        .alert.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .alert-success {
            background: #1b5e20;
            color: #c8e6c9;
            border-color: #4caf50;
        }

        .alert-error {
            background: #b71c1c;
            color: #ffcdd2;
            border-color: #f44336;
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== ESTILOS DO MARKETPLACE ===== */
        #marketplace-page {
            display: none;
        }

        #marketplace-page.active {
            display: block;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
        }

        header {
            background-color: rgba(26, 26, 26, 0.95);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid #333;
            backdrop-filter: blur(10px);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
                padding: 10px 0;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            cursor: pointer;
            font-family: 'Oswald', sans-serif;
            text-decoration: none;
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 1.5rem;
            }
            
            .logo i {
                font-size: 1.8rem;
            }
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 30px;
            margin: 0;
            padding: 0;
        }

        @media (max-width: 768px) {
            nav ul {
                gap: 15px;
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        nav a {
            text-decoration: none;
            color: #e0e0e0;
            font-weight: 500;
            transition: var(--transition);
            padding: 5px 0;
            position: relative;
            cursor: pointer;
            font-family: 'Oswald', sans-serif;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        nav a:hover {
            color: var(--primary-light);
        }

        nav a.active {
            color: var(--primary);
        }

        nav a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .header-actions {
                flex-direction: column;
                gap: 10px;
            }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        .user-type-badge {
            background-color: var(--secondary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #555;
            white-space: nowrap;
        }

        /* Conteúdo da Página */
        .page-container {
            min-height: calc(100vh - 200px);
            padding: 40px 0;
            display: none;
        }

        .page-container.active {
            display: block;
        }

        .page-title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .page-title {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .page-title h1 {
            font-size: 2.2rem;
            color: white;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .page-title h1 {
                font-size: 1.8rem;
            }
        }

        .page-title .page-subtitle {
            color: var(--light-gray);
            font-weight: 400;
            font-size: 1rem;
            width: 100%;
        }

        /* Estilos de cartões industriais */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-heavy);
            border-color: var(--primary-light);
            background: rgba(255, 255, 255, 0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(211, 47, 47, 0.15);
            color: var(--primary-light);
            border: 2px solid rgba(211, 47, 47, 0.3);
            flex-shrink: 0;
        }

        .stat-info h3 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: white;
        }

        .stat-info p {
            color: var(--light-gray);
        }

        /* Estilos de Tabela */
        .table-container {
            background: rgba(255, 255, 255, 0.08);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            flex-wrap: wrap;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .table-header h3 {
            margin: 0;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 100%;
            }
        }

        th {
            text-align: left;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: white;
            font-family: 'Oswald', sans-serif;
            white-space: nowrap;
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--light-gray);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid;
            white-space: nowrap;
        }

        .status-pending {
            background-color: rgba(255, 243, 224, 0.1);
            color: #ffb74d;
            border-color: rgba(255, 204, 128, 0.3);
        }

        .status-quoted {
            background-color: rgba(227, 242, 253, 0.1);
            color: #64b5f6;
            border-color: rgba(144, 202, 249, 0.3);
        }

        .status-in-progress {
            background-color: rgba(232, 245, 233, 0.1);
            color: #81c784;
            border-color: rgba(165, 214, 167, 0.3);
        }

        .status-completed {
            background-color: rgba(241, 248, 233, 0.1);
            color: #a5d6a7;
            border-color: rgba(197, 225, 165, 0.3);
        }

        .status-cancelled {
            background-color: rgba(245, 245, 245, 0.1);
            color: #bdbdbd;
            border-color: rgba(224, 224, 224, 0.3);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            color: var(--primary-light);
            font-size: 1.2rem;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            margin: 2px;
        }

        /* Abas */
        .tabs {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
            flex-wrap: wrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            font-family: 'Oswald', sans-serif;
            color: var(--light-gray);
            flex-shrink: 0;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards industriais */
        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-heavy);
            border-color: var(--primary-light);
            background: rgba(255, 255, 255, 0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-title h3 {
            margin-bottom: 5px;
            color: white;
        }

        .card-meta {
            display: flex;
            gap: 20px;
            color: var(--light-gray);
            font-size: 0.9rem;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .card-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--light-gray);
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 500;
            color: white;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .card-actions {
                justify-content: flex-start;
            }
        }

        /* Página Inicial */
        .hero {
            padding: 100px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .hero {
                padding: 60px 0;
            }
        }

        .hero h1 {
            font-size: 3.2rem;
            margin-bottom: 20px;
            color: white;
            position: relative;
            z-index: 2;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.2rem;
            }
        }

        .hero p {
            font-size: 1.2rem;
            color: #bdbdbd;
            max-width: 700px;
            margin: 0 auto 40px;
            position: relative;
            z-index: 2;
        }

        @media (max-width: 768px) {
            .hero p {
                font-size: 1rem;
                padding: 0 10px;
            }
        }

        .hero-btns {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            position: relative;
            z-index: 2;
        }

        .file-types {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            position: relative;
            z-index: 2;
        }

        .file-type-tag {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--primary-light);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid rgba(211, 47, 47, 0.2);
        }

        /* Seção de Upload - CENTRALIZADA */
        .upload-section {
            padding: 60px 0;
        }

        @media (max-width: 768px) {
            .upload-section {
                padding: 40px 0;
            }
        }

        .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .upload-area {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 2px dashed rgba(189, 189, 189, 0.5);
            border-radius: var(--border-radius);
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .upload-area {
                padding: 40px 15px;
            }
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(255, 235, 238, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(255, 235, 238, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--light-gray);
            margin-bottom: 20px;
        }

        .upload-area h3 {
            margin-bottom: 10px;
            color: white;
        }

        /* Títulos centralizados na primeira aba */
        .section-title {
            text-align: center;
            margin-bottom: 40px;
        }

        .section-title h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: white;
        }

        @media (max-width: 768px) {
            .section-title h2 {
                font-size: 2rem;
            }
        }

        .section-title p {
            font-size: 1.2rem;
            color: var(--light-gray);
            max-width: 600px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .section-title p {
                font-size: 1rem;
                padding: 0 10px;
            }
        }

        /* Formulários */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.08);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            width: 100%;
        }

        @media (max-width: 768px) {
            .form-container {
                padding: 20px;
            }
        }

        /* Estilo do select de ordenação */
        .project-sort {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            color: white;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            cursor: pointer;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .project-sort:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2);
        }

        .project-sort option {
            background: #2c2c2c;
            color: white;
        }

        /* Botão OK para orçamentos */
        .btn-ok {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .btn-ok:hover {
            background: rgba(76, 175, 80, 0.3);
            color: #a5d6a7;
        }

        /* Modais */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(45, 45, 45, 0.95);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
            box-shadow: var(--box-shadow-heavy);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        @media (max-width: 768px) {
            .modal-content {
                max-height: 90vh;
            }
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h3 {
            color: white;
            margin: 0;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            flex-wrap: wrap;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-gray);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Notificação */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            box-shadow: var(--box-shadow-heavy);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
            border-left: 4px solid;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .notification {
                top: 80px;
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
            }
        }

        .notification.active {
            transform: translateX(0);
        }

        .notification-success {
            background: rgba(46, 125, 50, 0.9);
            border-color: #4caf50;
        }

        .notification-error {
            background: rgba(198, 40, 40, 0.9);
            border-color: #f44336;
        }

        .notification-info {
            background: rgba(21, 101, 192, 0.9);
            border-color: #2196f3;
        }

        .notification-warning {
            background: rgba(245, 124, 0, 0.9);
            border-color: #ff9800;
        }

        /* Métodos de Fabricação - Cards Industriais */
        .methods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        @media (max-width: 768px) {
            .methods-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .methods-grid {
                grid-template-columns: 1fr;
            }
        }

        .method-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .method-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary);
        }

        .method-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-heavy);
            border-color: var(--primary-light);
            background: rgba(255, 255, 255, 0.12);
        }

        .method-header {
            background: rgba(211, 47, 47, 0.15);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .method-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
            flex-shrink: 0;
        }

        .method-header h3 {
            color: white;
            margin: 0;
        }

        .method-body {
            padding: 20px;
            color: var(--light-gray);
        }

        .method-body ul {
            list-style-position: inside;
            color: var(--light-gray);
            margin-top: 10px;
            padding-left: 0;
        }

        .method-body li {
            margin-bottom: 8px;
            padding-left: 5px;
        }

        /* Cards de Orçamento */
        .quote-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .quote-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary);
        }

        .quote-card:hover {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .quote-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quote-card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Rodapé */
        footer {
            background-color: rgba(26, 26, 26, 0.95);
            color: white;
            padding: 60px 0 30px;
            border-top: 1px solid #333;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            footer {
                padding: 40px 0 20px;
            }
        }

        .footer-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .footer-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 30px;
            }
        }

        @media (max-width: 480px) {
            .footer-container {
                grid-template-columns: 1fr;
            }
        }

        .footer-column h3 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: white;
            font-family: 'Oswald', sans-serif;
        }

        .footer-column ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-column ul li {
            margin-bottom: 10px;
        }

        .footer-column a {
            color: #bdbdbd;
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            display: inline-block;
        }

        .footer-column a:hover {
            color: var(--primary-light);
        }

        .copyright {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid #333;
            color: #757575;
            font-size: 0.9rem;
        }
        
        /* Controle de Acesso */
        .nav-link.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .nav-link.disabled::after {
            content: "⛔";
            position: absolute;
            top: -5px;
            right: -15px;
            font-size: 0.7rem;
        }

        .nav-link.disabled:hover {
            color: #bdbdbd !important;
        }

        .access-restricted {
            filter: blur(2px);
            pointer-events: none;
            user-select: none;
            opacity: 0.7;
        }

        .access-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: var(--border-radius);
        }

        .access-overlay i {
            font-size: 3rem;
            color: var(--primary-light);
            margin-bottom: 15px;
        }

        .access-overlay h3 {
            color: white;
            margin-bottom: 10px;
        }

        .access-overlay p {
            color: var(--light-gray);
            text-align: center;
            max-width: 300px;
        }

        /* Novos estilos para upload de PDF */
        .pdf-upload-area {
            border: 2px dashed rgba(189, 189, 189, 0.5);
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.08);
        }

        .pdf-upload-area:hover {
            border-color: var(--primary);
            background: rgba(255, 235, 238, 0.1);
        }

        .pdf-upload-area.dragover {
            border-color: var(--primary);
            background: rgba(255, 235, 238, 0.1);
        }

        .pdf-upload-icon {
            font-size: 2.5rem;
            color: var(--light-gray);
            margin-bottom: 15px;
        }

        .pdf-upload-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pdf-file-name {
            font-weight: 500;
            color: white;
            word-break: break-all;
        }

        .pdf-remove-btn {
            background: none;
            border: none;
            color: var(--primary-light);
            cursor: pointer;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .quote-pdf-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-light);
            text-decoration: none;
            font-weight: 500;
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(211, 47, 47, 0.1);
            border-radius: var(--border-radius);
            transition: var(--transition);
            border: 1px solid rgba(211, 47, 47, 0.2);
            word-break: break-word;
        }

        .quote-pdf-link:hover {
            background: rgba(211, 47, 47, 0.2);
            text-decoration: underline;
        }

        /* ===== NOVOS ESTILOS PARA O CHAT ===== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 400px;
            }
        }

        .chat-header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-header h4 {
            color: white;
            margin-bottom: 5px;
        }

        .chat-header p {
            color: var(--light-gray);
            font-size: 0.9rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            position: relative;
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .chat-message {
                max-width: 90%;
            }
        }

        .chat-message.sent {
            align-self: flex-end;
            background: rgba(211, 47, 47, 0.2);
            border: 1px solid rgba(211, 47, 47, 0.3);
        }

        .chat-message.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message-sender {
            font-weight: 600;
            color: white;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        .message-text {
            color: var(--light-gray);
            line-height: 1.4;
        }

        .message-time {
            text-align: right;
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            color: white;
            font-family: 'Roboto', sans-serif;
            resize: none;
            max-height: 100px;
            min-height: 40px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-chat {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .btn-chat:hover {
            background: var(--primary-dark);
        }

        .chat-empty {
            text-align: center;
            color: var(--light-gray);
            padding: 40px;
        }

        .chat-empty i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .unread-badge {
            background-color: var(--primary);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Efeitos industriais adicionais */
        .industrial-border {
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .bolt {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        .bolt-top-left {
            top: 5px;
            left: 5px;
        }

        .bolt-top-right {
            top: 5px;
            right: 5px;
        }

        .bolt-bottom-left {
            bottom: 5px;
            left: 5px;
        }

        .bolt-bottom-right {
            bottom: 5px;
            right: 5px;
        }

        /* Ajustes para botões em telas pequenas */
        @media (max-width: 480px) {
            .btn-large {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .hero-btns {
                flex-direction: column;
                align-items: center;
            }
            
            .hero-btns .btn {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Ajustes para modais em telas pequenas */
        @media (max-width: 768px) {
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                max-width: 95%;
            }
        }

        /* Ajustes para formulários em telas pequenas */
        @media (max-width: 480px) {
            .form-container-auth {
                padding: 20px 15px;
            }
            
            .form-header h3 {
                font-size: 1.5rem;
            }
        }

        /* Ajustes para tabelas em telas pequenas */
        @media (max-width: 768px) {
            th, td {
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div id="notification-area"></div>

    <!-- ========== PÁGINA DE LOGIN ========== -->
    <div id="auth-page" class="active">
        <div class="auth-container">
            <div class="auth-side left">
                <div>
                    <div class="auth-logo">
                        <i class="fas fa-industry"></i>
                        <span>FabricateHub</span>
                    </div>
                    <h2>Conecte-se com Fabricantes de Qualidade</h2>
                    <p>A plataforma que conecta designers e engenheiros com fabricantes especializados.</p>
                    
                    <div class="features">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <strong>Orçamentos em até 48h!</strong><br>
                                Receba múltiplas propostas rapidamente
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div>
                                <strong>Pagamentos Seguros</strong><br>
                                Transações protegidas e confiáveis
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div>
                                <strong>Fabricantes Verificados</strong><br>
                                Trabalhe com profissionais qualificados
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="auth-side right">
                <div id="alert" class="alert"></div>

                <!-- Login Form -->
                <div id="login-form" class="form-container-auth active">
                    <div class="form-header">
                        <h3>Bem-vindo de volta!</h3>
                        <p>Entre com sua conta para continuar</p>
                    </div>

                    <form id="loginForm">
                        <div class="form-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" required placeholder="seu@email.com">
                        </div>

                        <div class="form-group">
                            <label for="login-password">Senha</label>
                            <div class="password-input">
                                <input type="password" id="login-password" required placeholder="••••••••">
                                <button type="button" class="password-toggle" onclick="togglePassword('login-password')">
                                    <i class="far fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div style="text-align: right; margin-bottom: 20px;">
                            <a onclick="showAuthForm('forgot')" style="color: var(--primary-light); cursor: pointer; font-size: 0.9rem;">Esqueceu sua senha?</a>
                        </div>

                        <button type="submit" class="btn btn-primary" id="login-btn">
                            <span>Entrar</span>
                        </button>
                    </form>

                     <div class="form-footer">
                        Não tem uma conta? <a onclick="showAuthForm('signup')">Criar conta</a>
                    </div>
                </div>

                <!-- Signup Form -->
                <div id="signup-form" class="form-container-auth">
                    <div class="form-header">
                        <h3>Criar sua conta</h3>
                        <p>Comece a fabricar hoje mesmo</p>
                    </div>

                    <form id="signupForm">
                        <div class="form-group">
                            <label for="signup-name">Nome Completo</label>
                            <input type="text" id="signup-name" required placeholder="João Silva">
                        </div>

                        <div class="form-group">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" required placeholder="seu@email.com">
                        </div>

                        <div class="form-group">
                            <label for="signup-password">Senha</label>
                            <div class="password-input">
                                <input type="password" id="signup-password" required placeholder="Mínimo 6 caracteres" minlength="6">
                                <button type="button" class="password-toggle" onclick="togglePassword('signup-password')">
                                    <i class="far fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="signup-usertype">Tipo de Conta</label>
                            <select id="signup-usertype" required onchange="toggleConditionalFields()">
                                <option value="">Selecione...</option>
                                <option value="client">Cliente - Preciso fabricar peças</option>
                                <option value="fabricator">Fabricante - Quero oferecer serviços</option>
                            </select>
                        </div>

                        <!-- Campos condicionais para Cliente -->
                        <div id="client-fields" class="conditional-fields">
                            <h4 style="color: white; margin-bottom: 15px; font-family: 'Oswald', sans-serif;">Informações do Cliente</h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="client-cpf">CPF</label>
                                    <input type="text" id="client-cpf" placeholder="000.000.000-00">
                                </div>
                                <div class="form-group">
                                    <label for="client-cep">CEP</label>
                                    <input type="text" id="client-cep" placeholder="00000-000">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="client-subtype">Tipo de Cliente</label>
                                <select id="client-subtype">
                                    <option value="">Selecione...</option>
                                    <option value="physical_person">Pessoa Física - Requisitando projetos específicos</option>
                                    <option value="manufacturer_seeking_suppliers">Fabricante - Procurando novos fornecedores</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campos condicionais para Fabricante -->
                        <div id="fabricator-fields" class="conditional-fields">
                            <h4 style="color: white; margin-bottom: 15px; font-family: 'Oswald', sans-serif;">Informações da Empresa</h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fabricator-cnpj">CNPJ</label>
                                    <input type="text" id="fabricator-cnpj" placeholder="00.000.000/0000-00">
                                </div>
                                <div class="form-group">
                                    <label for="fabricator-cep">CEP</label>
                                    <input type="text" id="fabricator-cep" placeholder="00000-000">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fabricator-company-name">Nome da Empresa</label>
                                    <input type="text" id="fabricator-company-name" placeholder="Nome da sua empresa">
                                </div>
                                <div class="form-group">
                                    <label for="fabricator-company-age">Tempo de Atuação (anos)</label>
                                    <input type="number" id="fabricator-company-age" min="0" placeholder="Opcional">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-group-label">Áreas de Atuação</label>
                                <div class="checkbox-grid">
                                    <div class="form-checkbox-group">
                                        <input type="checkbox" id="area-cnc" value="cnc-machining">
                                        <label for="area-cnc">Usinagem CNC</label>
                                    </div>
                                    <div class="form-checkbox-group">
                                        <input type="checkbox" id="area-laser" value="laser-cutting">
                                        <label for="area-laser">Corte a Laser</label>
                                    </div>
                                    <div class="form-checkbox-group">
                                        <input type="checkbox" id="area-3d" value="3d-printing">
                                        <label for="area-3d">Impressão 3D</label>
                                    </div>
                                    <div class="form-checkbox-group">
                                        <input type="checkbox" id="area-machining" value="machining">
                                        <label for="area-machining">Usinagem Convencional</label>
                                    </div>
                                    <div class="form-checkbox-group">
                                        <input type="checkbox" id="area-welding" value="welding">
                                        <label for="area-welding">Soldagem</label>
                                    </div>
                                    <div class="form-checkbox-group">
                                        <input type="checkbox" id="area-wood" value="wood-fabrication">
                                        <label for="area-wood">Fabricação em Madeira</label>
                                    </div>
                                    <div class="form-checkbox-group">
                                        <input type="checkbox" id="area-metal-bending" value="metal-bending">
                                        <label for="area-metal-bending">Conformação</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-group-label">Preferência de Formato de Arquivo</label>
                                <div class="file-format-options">
                                    <label class="file-format-option">
                                        <input type="radio" name="file-format-pref" value="dedicated" checked>
                                        <div class="file-format-info">
                                            <div class="file-format-title">Formatos Dedicados</div>
                                            <div class="file-format-desc">STL, STEP, IGES, DXF, DWG, SLDPRT, 3DM, OBJ</div>
                                        </div>
                                    </label>
                                    <label class="file-format-option">
                                        <input type="radio" name="file-format-pref" value="simple">
                                        <div class="file-format-info">
                                            <div class="file-format-title">Formatos Simples/PDF</div>
                                            <div class="file-format-desc">PDF, imagens, desenhos técnicos simples</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="signup-btn">
                            <span>Criar Conta</span>
                        </button>
                    </form>

                    <div class="form-footer">
                        Já tem uma conta? <a onclick="showAuthForm('login')">Fazer login</a>
                    </div>
                </div>

                <!-- Forgot Password Form -->
                <div id="forgot-form" class="form-container-auth">
                    <div class="form-header">
                        <h3>Recuperar Senha</h3>
                        <p>Digite seu email para receber instruções</p>
                    </div>

                    <form id="forgotForm">
                        <div class="form-group">
                            <label for="forgot-email">Email</label>
                            <input type="email" id="forgot-email" required placeholder="seu@email.com">
                        </div>

                        <button type="submit" class="btn btn-primary" id="forgot-btn">
                            <span>Enviar Instruções</span>
                        </button>
                    </form>

                    <div class="form-footer">
                        <a onclick="showAuthForm('login')">← Voltar ao login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MARKETPLACE ========== -->
    <div id="marketplace-page">
        <!-- Cabeçalho -->
        <header>
            <div class="container header-container">
                <a class="logo" id="logo">
                    <i class="fas fa-industry"></i>
                    <span>FabricateHub</span>
                </a>
                <nav>
                    <ul>
                        <li><a id="nav-home" class="nav-link active">Início</a></li>
                        <li><a id="nav-client" class="nav-link">Painel do Cliente</a></li>
                        <li><a id="nav-fabricator" class="nav-link">Painel do Fabricante</a></li>
                        <li><a id="nav-methods" class="nav-link">Métodos de Fabricação</a></li>
                    </ul>
                </nav>
                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">JD</div>
                        <div>
                            <div id="user-name">João Designer</div>
                            <div class="user-type-badge" id="user-type-badge">Cliente</div>
                        </div>
                    </div>
                    <button class="btn btn-outline" id="logout-btn">Sair</button>
                </div>
            </div>
        </header>

        <!-- Página Inicial -->
        <div id="home-page" class="page-container active">
            <section class="hero">
                <div class="container">
                    <h1>Conecte-se com Fabricantes para Peças Personalizadas</h1>
                    <p>Faça upload dos seus arquivos de engenharia (STL, STEP, DXF) e receba orçamentos de fabricantes independentes especializados em usinagem, corte a laser, soldagem, manufatura 3D, fabricação em madeira e muito mais.</p>
                    <div class="hero-btns">
                        <button class="btn btn-primary btn-large" id="get-quote-btn">
                            <i class="fas fa-upload"></i> Solicitar Orçamento
                        </button>
                        <button class="btn btn-outline btn-large" id="browse-manufacturers-btn">
                            <i class="fas fa-search"></i> Métodos de fabricação
                        </button>
                    </div>
                    <div class="file-types">
                        <span class="file-type-tag">STL</span>
                        <span class="file-type-tag">STEP</span>
                        <span class="file-type-tag">IGES</span>
                        <span class="file-type-tag">DXF</span>
                        <span class="file-type-tag">DWG</span>
                        <span class="file-type-tag">SLDPRT</span>
                        <span class="file-type-tag">3DM</span>
                        <span class="file-type-tag">OBJ</span>
                    </div>
                </div>
            </section>

            <section class="upload-section" id="upload-section">
                <div class="container">
                    <!-- Títulos centralizados -->
                    <div class="section-title">
                        <h2>Envie Seu Projeto</h2>
                        <p>Receba orçamentos enviando seus arquivos de engenharia</p>
                    </div>
                    
                    <div class="upload-container">
                        <div class="upload-area" id="upload-area">
                            <div id="upload-content">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3>Arraste e Solte Seus Arquivos Aqui</h3>
                                <p>ou clique para procurar arquivos no seu computador</p>
                                <div class="file-types">
                                    <span class="file-type-tag">STL</span>
                                    <span class="file-type-tag">STEP</span>
                                    <span class="file-type-tag">IGES</span>
                                    <span class="file-type-tag">DXF</span>
                                    <span class="file-type-tag">DWG</span>
                                    <span class="file-type-tag">PDF</span>
                                </div>
                                <p style="font-size: 0.85rem; color: var(--light-gray); margin-top: 15px;">
                                    <i class="fas fa-info-circle"></i> Tamanho máximo do arquivo: 50MB
                                </p>
                            </div>
                        </div>
                        <input type="file" id="file-input" multiple style="display: none;">
                        
                        <div class="form-container">
                            <form id="project-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="project-name">Nome do Projeto</label>
                                        <input type="text" id="project-name" placeholder="Ex: Invólucro de Alumínio" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="project-quantity">Quantidade</label>
                                        <input type="number" id="project-quantity" min="1" value="1" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="project-material">Material</label>
                                        <select id="project-material" required>
                                            <option value="">Selecione o Material</option>
                                            <option value="aluminum">Alumínio</option>
                                            <option value="steel">Aço</option>
                                            <option value="stainless-steel">Aço Inoxidável</option>
                                            <option value="brass">Latão</option>
                                            <option value="plastic">Plástico</option>
                                            <option value="wood">Madeira</option>
                                            <option value="other">Outro</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="project-method">Método de Fabricação</label>
                                        <select id="project-method" required>
                                            <option value="">Selecione o Método</option>
                                            <option value="cnc-machining">Usinagem CNC</option>
                                            <option value="laser-cutting">Corte a Laser</option>
                                            <option value="3d-printing">Impressão 3D</option>
                                            <option value="machining">Usinagem</option>
                                            <option value="welding">Soldagem</option>
                                            <option value="wood-fabrication">Fabricação em Madeira</option>
                                            <option value="metal-bending">Conformação</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="project-due-date">Data de Conclusão Desejada</label>
                                    <input type="date" id="project-due-date" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="project-description">Descrição do Projeto e Requisitos</label>
                                    <textarea id="project-description" rows="4" placeholder="Descreva seu projeto, requisitos especiais, tolerâncias, acabamento superficial, etc." required></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px;">
                                        <i class="fas fa-paper-plane"></i> Enviar Projeto para Orçamentos
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Painel do Cliente -->
        <div id="client-page" class="page-container">
            <div class="container">
                <div class="page-title">
                    <div>
                        <h1>Painel do Cliente</h1>
                        <div class="page-subtitle">Gerencie seus projetos e orçamentos</div>
                    </div>
                    <button class="btn btn-primary" id="new-project-btn">
                        <i class="fas fa-plus"></i> Novo Projeto
                    </button>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card" id="total-projects-stat">
                        <div class="stat-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-projects-count">0</h3>
                            <p>Total de Projetos</p>
                        </div>
                    </div>
                    <div class="stat-card" id="pending-quotes-stat">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pending-quotes-count">0</h3>
                            <p>Orçamentos Recebidos</p>
                        </div>
                    </div>
                    <div class="stat-card" id="active-projects-stat">
                        <div class="stat-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="active-projects-count">0</h3>
                            <p>Projetos Ativos</p>
                        </div>
                    </div>
                    <div class="stat-card" id="completed-projects-stat">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="completed-projects-count">0</h3>
                            <p>Projetos Concluídos</p>
                        </div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="client-all">Todos os Projetos</div>
                    <div class="tab" data-tab="client-pending">Orçamentos Recebidos</div>
                    <div class="tab" data-tab="client-active">Projetos Ativos</div>
                    <div class="tab" data-tab="client-completed">Concluídos</div>
                </div>
                
                <div id="client-all" class="tab-content active">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Meus Projetos</h3>
                            <div>
                                <select id="client-project-sort" class="project-sort">
                                    <option value="newest">Ordenar por: Mais Recentes</option>
                                    <option value="oldest">Ordenar por: Mais Antigos</option>
                                    <option value="name">Ordenar por: Nome</option>
                                    <option value="status">Ordenar por: Status</option>
                                </select>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome do Projeto</th>
                                    <th>Data</th>
                                    <th>Método</th>
                                    <th>Orçamentos</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="client-projects-table">
                                <!-- Projetos do cliente serão populados aqui por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="client-pending" class="tab-content">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Orçamentos Pendentes</h3>
                            <div>
                                <select id="client-pending-sort" class="project-sort">
                                    <option value="newest">Ordenar por: Mais Recentes</option>
                                    <option value="oldest">Ordenar por: Mais Antigos</option>
                                    <option value="name">Ordenar por: Nome</option>
                                    <option value="status">Ordenar por: Status</option>
                                </select>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome do Projeto</th>
                                    <th>Data</th>
                                    <th>Método</th>
                                    <th>Orçamentos</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="client-pending-table">
                                <!-- Projetos com status 'pending' serão populados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="client-active" class="tab-content">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Projetos Ativos</h3>
                            <div>
                                <select id="client-active-sort" class="project-sort">
                                    <option value="newest">Ordenar por: Mais Recentes</option>
                                    <option value="oldest">Ordenar por: Mais Antigos</option>
                                    <option value="name">Ordenar por: Nome</option>
                                    <option value="status">Ordenar por: Status</option>
                                </select>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome do Projeto</th>
                                    <th>Data</th>
                                    <th>Método</th>
                                    <th>Orçamentos</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="client-active-table">
                                <!-- Projetos com status 'in-progress' ou 'accepted' serão populados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="client-completed" class="tab-content">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Projetos Concluídos</h3>
                            <div>
                                <select id="client-completed-sort" class="project-sort">
                                    <option value="newest">Ordenar por: Mais Recentes</option>
                                    <option value="oldest">Ordenar por: Mais Antigos</option>
                                    <option value="name">Ordenar por: Nome</option>
                                    <option value="status">Ordenar por: Status</option>
                                </select>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome do Projeto</th>
                                    <th>Data</th>
                                    <th>Método</th>
                                    <th>Orçamentos</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="client-completed-table">
                                <!-- Projetos com status 'completed' serão populados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel do Fabricante -->
        <div id="fabricator-page" class="page-container">
            <div class="container">
                <div class="page-title">
                    <div>
                        <h1>Painel do Fabricante</h1>
                        <div class="page-subtitle">Encontre projetos e envie orçamentos</div>
                    </div>
                    <button class="btn btn-outline" id="update-capabilities-btn">
                        <i class="fas fa-edit"></i> Atualizar Capacidades
                    </button>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card" id="active-requests-stat">
                        <div class="stat-icon">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="active-requests-count">0</h3>
                            <p>Solicitações Ativas</p>
                        </div>
                    </div>
                    <div class="stat-card" id="quotes-submitted-stat">
                        <div class="stat-icon">
                            <i class="fas fa-file-signature"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="quotes-submitted-count">0</h3>
                            <p>Orçamentos Enviados</p>
                        </div>
                    </div>
                    <div class="stat-card" id="jobs-completed-stat">
                        <div class="stat-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="jobs-completed-count">0</h3>
                            <p>Trabalhos Ativos</p>
                        </div>
                    </div>
                    <div class="stat-card" id="completed-jobs-stat">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="completed-jobs-count">0</h3>
                            <p>Trabalhos Concluídos</p>
                        </div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="fabricator-new">Novas Solicitações</div>
                    <div class="tab" data-tab="fabricator-quotes">Meus Orçamentos</div>
                    <div class="tab" data-tab="fabricator-active">Trabalhos Ativos</div>
                    <div class="tab" data-tab="fabricator-completed">Trabalhos Concluídos</div>
                </div>
                
                <div id="fabricator-new" class="tab-content active">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Novas Solicitações de Projetos</h3>
                            <div>
                                <select id="fabricator-new-sort" class="project-sort">
                                    <option value="newest">Ordenar por: Mais Recentes</option>
                                    <option value="oldest">Ordenar por: Mais Antigos</option>
                                    <option value="name">Ordenar por: Nome</option>
                                </select>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Projeto</th>
                                    <th>Cliente</th>
                                    <th>Método</th>
                                    <th>Material</th>
                                    <th>Prazo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="fabricator-new-requests-table">
                                <!-- Novas solicitações serão populadas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="fabricator-quotes" class="tab-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Projeto</th>
                                    <th>Cliente</th>
                                    <th>Valor do Orçamento</th>
                                    <th>Data de Envio</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="fabricator-quotes-table">
                                <!-- Orçamentos enviados serão populados aqui por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="fabricator-active" class="tab-content">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Trabalhos em Andamento</h3>
                            <div>
                                <select id="fabricator-active-sort" class="project-sort">
                                    <option value="newest">Ordenar por: Mais Recentes</option>
                                    <option value="oldest">Ordenar por: Mais Antigos</option>
                                    <option value="progress">Ordenar por: Progresso</option>
                                </select>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Projeto</th>
                                    <th>Cliente</th>
                                    <th>Progresso</th>
                                    <th>Data Entrega</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="fabricator-active-jobs-table">
                                <!-- Trabalhos ativos serão populados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="fabricator-completed" class="tab-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Projeto</th>
                                    <th>Cliente</th>
                                    <th>Data de Conclusão</th>
                                    <th>Valor</th>
                                    <th>Avaliação</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="fabricator-completed-table">
                                <!-- Trabalhos concluídos serão populados aqui por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Métodos de Fabricação -->
        <div id="methods-page" class="page-container">
            <div class="container">
                <div class="page-title">
                    <h1>Métodos de Fabricação</h1>
                    <div class="page-subtitle">Explore as capacidades de manufatura de nossos fabricantes</div>
                </div>  
                
                <div class="methods-grid">
                    <div class="method-card" data-method="cnc-machining">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <h3>Usinagem CNC</h3>
                        </div>
                        <div class="method-body">
                            <p>Usinagem de precisão de metais e plásticos com tolerâncias apertadas.</p>
                            <ul>
                                <li>Fresamento 3, 4 e 5 eixos</li>
                                <li>Torneamento e fresagem CNC</li>
                                <li>Geometrias complexas</li>
                                <li>Tolerâncias até ±0,001"</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="method-card" data-method="laser-cutting">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-cut"></i>
                            </div>
                            <h3>Corte em chapas</h3>
                        </div>
                        <div class="method-body">
                            <p>Corte de precisão de chapas metálicas e ligas com bordas limpas.</p>
                            <ul>
                                <li>Aço, alumínio, latão</li>
                                <li>Espessura até 1"</li>
                                <li>Designs intricados</li>
                                <li>Entrega rápida</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="method-card" data-method="3d-printing">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-cube"></i>
                            </div>
                            <h3>Impressão 3D</h3>
                        </div>
                        <div class="method-body">
                            <p>Manufatura aditiva que constrói peças camada por camada a partir de modelos digitais.</p>
                            <ul>
                                <li>FDM, SLA, SLS, Impressão 3D em Metal</li>
                                <li>Prototipagem rápida</li>
                                <li>Protótipos funcionais</li>
                                <li>Produção de baixo volume</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="method-card" data-method="machining">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <h3>Usinagem Convencional</h3>
                        </div>
                        <div class="method-body">
                            <p>Usinagem tradicional com tornos, fresadoras e furadeiras para produção de peças metálicas.</p>
                            <ul>
                                <li>Torneamento convencional</li>
                                <li>Fresamento manual</li>
                                <li>Furação e rosqueamento</li>
                                <li>Retificação de superfícies</li>
                                <li>Peças únicas e pequenas séries</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="method-card" data-method="welding">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-industry"></i>
                            </div>
                            <h3>Soldagem e Fabricação</h3>
                        </div>
                        <div class="method-body">
                            <p>Serviços de fabricação e soldagem metálica para componentes estruturais, quadros e montagens personalizadas.</p>
                            <ul>
                                <li>Solda TIG (precisão)</li>
                                <li>Solda MIG (produção)</li>
                                <li>Solda com eletrodo revestido</li>
                                <li>Corte a plasma</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="method-card" data-method="wood-fabrication">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-tree"></i>
                            </div>
                            <h3>Fabricação em Madeira</h3>
                        </div>
                        <div class="method-body">
                            <p>Serviços de marcenaria e carpintaria personalizados para móveis, elementos arquitetônicos e peças decorativas.</p>
                            <ul>
                                <li>Roteamento CNC em madeira</li>
                                <li>Móveis personalizados</li>
                                <li>Marcenaria arquitetônica</li>
                                <li>Acabamento e tingimento</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="method-card" data-method="metal-bending">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-bezier-curve"></i>
                            </div>
                            <h3>Conformação de Metais</h3>
                        </div>
                        <div class="method-body">
                            <p>Dobramento e conformação de chapas metálicas para criar peças com formas específicas e geometrias complexas.</p>
                            <ul>
                                <li>Dobramento de chapas</li>
                                <li>Prensas e calandras</li>
                                <li>Conformação a frio e a quente</li>
                                <li>Estampagem profunda</li>
                                <li>Peças estruturais e chassis</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modais -->
        <div id="quote-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Enviar Orçamento</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <form id="quote-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="quote-project-name">Projeto</label>
                            <input type="text" id="quote-project-name" readonly>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quote-amount">Valor do Orçamento (R$)</label>
                                <input type="number" id="quote-amount" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="quote-lead-time">Prazo de Entrega (Dias)</label>
                                <input type="number" id="quote-lead-time" min="1" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="quote-payment-terms">Condições de Pagamento</label>
                            <select id="quote-payment-terms" required>
                                <option value="">Selecione as Condições de Pagamento</option>
                                <option value="50% de entrada, 50% na conclusão">50% de entrada, 50% na conclusão</option>
                                <option value="100% na conclusão">100% na conclusão</option>
                                <option value="30 dias">30 dias</option>
                                <option value="Other">Outro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="quote-pdf-upload">Anexar PDF do Orçamento (Opcional)</label>
                            <div class="pdf-upload-area" id="pdf-upload-area">
                                <div id="pdf-upload-content">
                                    <div class="pdf-upload-icon">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <h4>Clique para selecionar ou arraste um PDF</h4>
                                    <p>Formato aceito: PDF (tamanho máximo: 10MB)</p>
                                    <p style="font-size: 0.85rem; color: var(--light-gray); margin-top: 10px;">
                                        <i class="fas fa-info-circle"></i> Você pode anexar um PDF detalhado com desenhos, especificações e condições
                                    </p>
                                </div>
                            </div>
                            <input type="file" id="quote-pdf-input" accept=".pdf" style="display: none;">
                            
                            <div id="pdf-file-info" style="display: none;">
                                <div class="pdf-upload-info">
                                    <div>
                                        <i class="fas fa-file-pdf" style="color: var(--primary-light); margin-right: 8px;"></i>
                                        <span class="pdf-file-name" id="pdf-file-name"></span>
                                    </div>
                                    <button type="button" class="pdf-remove-btn" id="pdf-remove-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="quote-notes">Observações para o Cliente</label>
                            <textarea id="quote-notes" rows="4" placeholder="Quaisquer observações especiais, condições ou esclarecimentos sobre seu orçamento..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline close-modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Enviar Orçamento</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="project-detail-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Detalhes do Projeto</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="project-detail-content">
                        <!-- Detalhes do projeto serão populados aqui por JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline close-modal">Fechar</button>
                </div>
            </div>
        </div>

        <div id="method-detail-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="method-detail-title"></h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="method-detail-content">
                        <!-- Detalhes do método serão populados aqui por JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline close-modal">Fechar</button>
                </div>
            </div>
        </div>

        <div id="capabilities-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Atualizar Capacidades de Fabricação</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <form id="capabilities-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Métodos de Fabricação</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                                <div>
                                    <input type="checkbox" id="cap-cnc" value="cnc-machining" checked>
                                    <label for="cap-cnc" style="color: white;">Usinagem CNC</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="cap-laser" value="laser-cutting" checked>
                                    <label for="cap-laser" style="color: white;">Corte a Laser</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="cap-3d" value="3d-printing" checked>
                                    <label for="cap-3d" style="color: white;">Impressão 3D</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="cap-prototype" value="prototyping" checked>
                                    <label for="cap-prototype" style="color: white;">Prototipagem</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="cap-wood" value="wood-fabrication">
                                    <label for="cap-wood" style="color: white;">Fabricação em Madeira</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="cap-welding" value="welding">
                                    <label for="cap-welding" style="color: white;">Soldagem</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cap-min-order">Valor Mínimo do Pedido (R$)</label>
                                <input type="number" id="cap-min-order" min="0" value="100">
                            </div>
                            <div class="form-group">
                                <label for="cap-max-size">Tamanho Máximo da Peça (cm)</label>
                                <input type="text" id="cap-max-size" placeholder="60x60x60">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="cap-lead-time">Prazo de Entrega Típico (Dias)</label>
                            <input type="number" id="cap-lead-time" min="1" value="14">
                        </div>
                        
                        <div class="form-group">
                            <label for="cap-materials">Materiais Disponíveis</label>
                            <textarea id="cap-materials" rows="3" placeholder="Liste os materiais com os quais você trabalha (separados por vírgula)"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline close-modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Capacidades</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="quote-detail-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Detalhes do Orçamento</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="quote-detail-content">
                        <!-- Detalhes do orçamento serão populados aqui por JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline close-modal">Fechar</button>
                </div>
            </div>
        </div>

        <!-- ========== MODAL DE CHAT ========== -->
        <div id="chat-modal" class="modal">
            <div class="modal-content" style="max-width: 800px; max-height: 85vh;">
                <div class="modal-header">
                    <h3 id="chat-project-name">Chat do Projeto</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; height: calc(85vh - 120px);">
                    <div class="chat-container">
                        <div class="chat-header">
                            <h4 id="chat-with-name">Carregando...</h4>
                            <p id="chat-project-info">Projeto: </p>
                        </div>
                        <div class="chat-messages" id="chat-messages">
                            <div class="chat-empty">
                                <i class="fas fa-comments"></i>
                                <p>Nenhuma mensagem ainda. Inicie a conversa!</p>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <textarea class="chat-input" id="chat-message-input" placeholder="Digite sua mensagem..." rows="1"></textarea>
                            <button class="btn-chat" id="send-chat-message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline close-modal">Fechar Chat</button>
                </div>
            </div>
        </div>

        <!-- Rodapé -->
        <footer>
            <div class="container">
                <div class="footer-container">
                    <div class="footer-column">
                        <h3>FabricateHub</h3>
                        <p style="color: #bdbdbd; margin-bottom: 20px;">Conectando clientes com fabricantes para fabricação de peças personalizadas desde 2026.</p>
                        <div style="display: flex; gap: 15px;">
                            <a><i class="fab fa-linkedin fa-lg"></i></a>
                            <a><i class="fab fa-twitter fa-lg"></i></a>
                            <a><i class="fab fa-facebook fa-lg"></i></a>
                            <a><i class="fab fa-instagram fa-lg"></i></a>
                        </div>
                    </div>
                    <div class="footer-column">
                        <h3>Para Clientes</h3>
                        <ul>
                            <li><a class="nav-link" data-page="home">Como Funciona</a></li>
                            <li><a id="pricing-link">Preços</a></li>
                            <li><a id="file-requirements-link">Requisitos de Arquivo</a></li>
                            <li><a id="material-guide-link">Guia de Materiais</a></li>
                            <li><a id="help-center-link">Central de Ajuda</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Para Fabricantes</h3>
                        <ul>
                            <li><a id="become-partner-link">Torne-se um Parceiro</a></li>
                            <li><a class="nav-link" data-page="fabricator">Painel do Fabricante</a></li>
                            <li><a id="capabilities-link">Verificação de Capacidade</a></li>
                            <li><a id="pricing-guidelines-link">Diretrizes de Preços</a></li>
                            <li><a id="manufacturer-resources-link">Recursos</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Empresa</h3>
                        <ul>
                            <li><a id="about-us-link">Sobre Nós</a></li>
                            <li><a id="blog-link">Blog</a></li>
                            <li><a id="careers-link">Carreiras</a></li>
                            <li><a id="contact-link">Contato</a></li>
                            <li><a id="privacy-link">Política de Privacidade</a></li>
                        </ul>
                    </div>
                </div>
                <div class="copyright">
                    <p>&copy; 2026 FabricateHub. Todos os direitos reservados.</p>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== CONFIGURAÇÃO SUPABASE ====================
        const SUPABASE_URL = 'https://evojynztlxbcyfsujtoy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2b2p5bnp0bHhiY3lmc3VqdG95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MTA0MDAsImV4cCI6MjA4NDA4NjQwMH0.ylCkwvVMnWsioaF08lyHTz6QQPoJ1DT9BpiOcU_zQyc';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let AppState = {
            currentUser: null,
            projects: [],
            fabricatorRequests: [],
            fabricatorQuotes: [],
            fabricatorJobs: [],
            fabricatorCapabilities: {
                methods: ["cnc-machining", "laser-cutting", "3d-printing", "prototyping"],
                minOrder: 100,
                maxSize: "60x60x60",
                leadTime: 14,
                materials: "Alumínio, Aço, Aço Inoxidável, ABS, PLA, Nylon"
            },
            currentQuoteProject: null,
            currentQuotePdfFile: null,
            currentChatProject: null,
            chatMessages: []
        };

        // ==================== FUNÇÕES DE LOGIN ====================
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            
            area.appendChild(notification);
            setTimeout(() => notification.classList.add('active'), 10);
            
            setTimeout(() => {
                notification.classList.remove('active');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> ${message}`;
        }

        function hideAlert() {
            document.getElementById('alert').classList.remove('show');
        }

        function showAuthForm(formName) {
            document.querySelectorAll('.form-container-auth').forEach(form => form.classList.remove('active'));
            document.getElementById(`${formName}-form`).classList.add('active');
            hideAlert();
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function setButtonLoading(buttonId, loading) {
            const btn = document.getElementById(buttonId);
            const span = btn.querySelector('span');
            
            if (loading) {
                btn.disabled = true;
                span.innerHTML = '<span class="loading-spinner"></span> Processando...';
            } else {
                btn.disabled = false;
                if (buttonId === 'login-btn') span.textContent = 'Entrar';
                else if (buttonId === 'signup-btn') span.textContent = 'Criar Conta';
                else if (buttonId === 'forgot-btn') span.textContent = 'Enviar Instruções';
            }
        }

        // Função para mostrar/ocultar campos condicionais
        function toggleConditionalFields() {
            const userType = document.getElementById('signup-usertype').value;
            const clientFields = document.getElementById('client-fields');
            const fabricatorFields = document.getElementById('fabricator-fields');
            
            if (clientFields) clientFields.classList.remove('active');
            if (fabricatorFields) fabricatorFields.classList.remove('active');
            
            if (userType === 'client' && clientFields) {
                clientFields.classList.add('active');
            } else if (userType === 'fabricator' && fabricatorFields) {
                fabricatorFields.classList.add('active');
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading('login-btn', true);
            hideAlert();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // Buscar perfil do usuário
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();

                if (profileError && profileError.code === 'PGRST116') {
                    // Perfil não existe, criar um
                    const { data: newProfile } = await supabaseClient
                        .from('profiles')
                        .insert([{
                            id: data.user.id,
                            name: data.user.email.split('@')[0],
                            user_type: 'client'
                        }])
                        .select()
                        .single();
                    
                    currentUser = {
                        id: data.user.id,
                        name: newProfile?.name || data.user.email.split('@')[0],
                        email: data.user.email,
                        type: newProfile?.user_type || 'client'
                    };
                } else if (profile) {
                    currentUser = {
                        id: data.user.id,
                        name: profile?.name || data.user.email.split('@')[0],
                        email: data.user.email,
                        type: profile?.user_type || 'client'
                    };
                } else {
                    throw new Error('Erro ao carregar perfil do usuário');
                }

                AppState.currentUser = currentUser;
                localStorage.setItem('fabricatehub_user', JSON.stringify(currentUser));

                showAlert('Login realizado com sucesso! Redirecionando...', 'success');
                
                setTimeout(() => {
                    showMarketplace();
                }, 1500);

            } catch (error) {
                console.error('Erro no login:', error);
                showAlert(error.message || 'Erro ao fazer login', 'error');
                setButtonLoading('login-btn', false);
            }
        });

        // Signup
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading('signup-btn', true);
            hideAlert();

            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const userType = document.getElementById('signup-usertype').value;

            // Coletar dados condicionais
            let additionalData = {};
            
            if (userType === 'client') {
                const cpf = document.getElementById('client-cpf').value;
                const cep = document.getElementById('client-cep').value;
                const clientSubtype = document.getElementById('client-subtype').value;
                
                additionalData = {
                    cpf,
                    cep,
                    client_subtype: clientSubtype,
                    company_name: null,
                    company_age: null,
                    fabrication_areas: null,
                    file_format_preference: null
                };
            } else if (userType === 'fabricator') {
                const cnpj = document.getElementById('fabricator-cnpj').value;
                const cep = document.getElementById('fabricator-cep').value;
                const companyName = document.getElementById('fabricator-company-name').value;
                const companyAge = document.getElementById('fabricator-company-age').value;
                
                // Coletar áreas de atuação selecionadas
                const areaCheckboxes = document.querySelectorAll('#fabricator-fields input[type="checkbox"]:checked');
                const fabricationAreas = Array.from(areaCheckboxes).map(cb => cb.value);
                
                // Coletar preferência de formato de arquivo
                const fileFormatPref = document.querySelector('input[name="file-format-pref"]:checked');
                const fileFormatPreference = fileFormatPref ? fileFormatPref.value : 'dedicated';
                
                additionalData = {
                    cnpj,
                    cep,
                    company_name: companyName,
                    company_age: companyAge || null,
                    fabrication_areas: fabricationAreas,
                    file_format_preference: fileFormatPreference,
                    cpf: null,
                    client_subtype: null
                };
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name,
                            user_type: userType
                        }
                    }
                });

                if (error) throw error;

                // Criar perfil do usuário com os dados adicionais
                const profileData = {
                    id: data.user.id,
                    name: name,
                    user_type: userType,
                    ...additionalData
                };
                
                const { error: profileError } = await supabaseClient
    .from('profiles')
    .insert([profileData]);

if (profileError) {
    console.error('Erro ao inserir perfil:', profileError);
    throw new Error('Erro ao salvar dados do perfil: ' + profileError.message);
}                showAlert('Conta criada com sucesso! Você pode fazer login agora.', 'success');
                
                document.getElementById('signupForm').reset();
                toggleConditionalFields(); // Resetar campos condicionais
                
                setTimeout(() => {
                    showAuthForm('login');
                }, 2000);

            } catch (error) {
                console.error('Erro no registro:', error);
                showAlert(error.message || 'Erro ao criar conta', 'error');
            } finally {
                setButtonLoading('signup-btn', false);
            }
        });

        // Forgot Password
        document.getElementById('forgotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading('forgot-btn', true);
            hideAlert();

            const email = document.getElementById('forgot-email').value;

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
                if (error) throw error;

                showAlert('Instruções enviadas para seu email!', 'success');
                document.getElementById('forgotForm').reset();

            } catch (error) {
                console.error('Erro:', error);
                showAlert(error.message || 'Erro ao enviar email', 'error');
            } finally {
                setButtonLoading('forgot-btn', false);
            }
        });

        // OAuth
        async function signInWithGoogle() {
            try {
                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: window.location.origin }
                });
                if (error) throw error;
            } catch (error) {
                showAlert(error.message || 'Erro ao fazer login com Google', 'error');
            }
        }

        async function signInWithGitHub() {
            try {
                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'github',
                    options: { redirectTo: window.location.origin }
                });
                if (error) throw error;
            } catch (error) {
                showAlert(error.message || 'Erro ao fazer login com GitHub', 'error');
            }
        }

        // Mostrar Marketplace
        function showMarketplace() {
            window.scrollTo(0, 0);
            document.body.style.overflow = 'auto';
            
            document.getElementById('auth-page').classList.remove('active');
            document.getElementById('marketplace-page').classList.add('active');
            
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-avatar').textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('user-type-badge').textContent = currentUser.type === 'client' ? 'Cliente' : 'Fabricante';
            
            // ===== CONTROLE DE ACESSO MODIFICADO =====
            const navFabricator = document.getElementById('nav-fabricator');
            const userType = currentUser.type;
            
            if (userType === 'client') {
              navFabricator.classList.add('disabled');
                
                if (document.getElementById('fabricator-page').classList.contains('active')) {
                    app.showPage('home');
                }
                
                const fabricatorPage = document.getElementById('fabricator-page');
                if (!fabricatorPage.querySelector('.access-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'access-overlay';
                    overlay.innerHTML = `
                        <i class="fas fa-lock"></i>
                        <h3>Acesso Restrito</h3>
                        <p>Esta área é exclusiva para fabricantes. Para acessar, faça login com uma conta de fabricante.</p>
                    `;
                    fabricatorPage.style.position = 'relative';
                    fabricatorPage.appendChild(overlay);
                }
                
            } else if (userType === 'fabricator') {
                navFabricator.classList.remove('disabled');
            
                // Clientes podem ver o link do painel do fabricante, mas será restrito
                navFabricator.classList.remove('disabled');
                
                if (document.getElementById('fabricator-page').classList.contains('active')) {
                    app.showPage('home');
                }
                
            } else if (userType === 'fabricator') {
                navFabricator.classList.remove('disabled');
                
                // Fabricantes podem acessar o painel do cliente normalmente
                const fabricatorPage = document.getElementById('fabricator-page');
                const overlay = fabricatorPage.querySelector('.access-overlay');
                if (overlay) {
                    overlay.remove();
                }
                
                // Garantir que o fabricante também possa acessar projetos como cliente
                loadClientProjectsFromSupabase().then(projects => {
                    console.log('Fabricante carregou', projects.length, 'projetos como cliente');
                });
            }
            // ===== FIM CONTROLE DE ACESSO =====
            
            showNotification(`Bem-vindo, ${currentUser.name}!`, 'success');
            
            app.init();
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (confirm('Deseja sair?')) {
                await supabaseClient.auth.signOut();
                localStorage.removeItem('fabricatehub_user');
                currentUser = null;
                AppState.currentUser = null;
                
                document.getElementById('marketplace-page').classList.remove('active');
                document.getElementById('auth-page').classList.add('active');
                
                const fabricatorPage = document.getElementById('fabricator-page');
                const overlay = fabricatorPage.querySelector('.access-overlay');
                if (overlay) {
                    overlay.remove();
                }
                fabricatorPage.style.position = '';
                showAuthForm('login');
                
                showAlert('Você saiu com sucesso!', 'success');
            }
        });

        // ==================== FUNÇÕES SUPABASE DO MARKETPLACE ====================
        async function loadClientProjectsFromSupabase() {
            try {
                const { data: projects, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('client_id', AppState.currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // LIMPAR ARRAY ANTES DE RECARREGAR
                AppState.projects = [];
                
                const formattedProjects = projects.map(project => ({
                    id: project.id,
                    name: project.name,
                    clientId: project.client_id,
                    clientName: AppState.currentUser.name,
                    fileName: project.file_name,
                    fileSize: project.file_size,
                    fileUrl: project.file_url,
                    date: project.created_at.split('T')[0],
                    dueDate: project.due_date,
                    method: project.method,
                    material: project.material,
                    quantity: project.quantity,
                    description: project.description,
                    status: project.status,
                    quotes: [],
                    selectedQuoteId: null,
                    acceptedQuoteId: null,
                    unreadMessages: 0,
                    progress: 0
                }));
                
                // Carregar orçamentos para cada projeto APENAS UMA VEZ
                for (let project of formattedProjects) {
                    const { data: quotes, error: quotesError } = await supabaseClient
                        .from('quotes')
                        .select('*')
                        .eq('project_id', project.id);
                    
                    if (!quotesError && quotes) {
                        const uniqueQuotesMap = new Map();
                        
                        for (let quote of quotes) {
                            if (!uniqueQuotesMap.has(quote.id)) {
                                const { data: fabricatorProfile } = await supabaseClient
                                    .from('profiles')
                                    .select('name')
                                    .eq('id', quote.fabricator_id)
                                    .single();
                                
                                uniqueQuotesMap.set(quote.id, {
                                    id: quote.id,
                                    fabricatorId: quote.fabricator_id,
                                    fabricatorName: fabricatorProfile?.name || 'Fabricante',
                                    amount: parseFloat(quote.amount),
                                    leadTime: quote.lead_time,
                                    date: quote.created_at.split('T')[0],
                                    status: quote.status,
                                    pdfUrl: quote.pdf_url || null,
                                    pdfFileName: quote.pdf_file_name || null,
                                    notes: quote.notes,
                                    paymentTerms: quote.payment_terms
                                });
                            }
                        }
                        
                        project.quotes = Array.from(uniqueQuotesMap.values());
                        
                        const acceptedQuote = project.quotes.find(q => q.status === 'accepted');
                        if (acceptedQuote) {
                            project.acceptedQuoteId = acceptedQuote.id;
                            project.selectedQuoteId = acceptedQuote.id;
                        }
                    }
                    
                    // Carregar progresso do job se o projeto estiver ativo
                    if (project.status === 'in-progress' || project.status === 'accepted') {
                        const { data: job, error: jobError } = await supabaseClient
                            .from('jobs')
                            .select('progress')
                            .eq('project_id', project.id)
                            .single();

                        if (!jobError && job) {
                            project.progress = job.progress;
                        } else {
                            project.progress = 0;
                        }
                    }
                    
                    // Carregar contagem de mensagens não lidas
                    if (project.status === 'in-progress' || project.status === 'accepted') {
                        const { count, error: msgError } = await supabaseClient
                            .from('messages')
                            .select('*', { count: 'exact', head: true })
                            .eq('project_id', project.id)
                            .eq('read', false)
                            .neq('sender_id', AppState.currentUser.id);
                        
                        if (!msgError && count) {
                            project.unreadMessages = count;
                        }
                    }
                    
                    AppState.projects.push(project);
                }
                
                return AppState.projects;
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
                showNotification('Erro ao carregar projetos do servidor', 'error');
                return [];
            }
        }

        async function loadFabricatorRequestsFromSupabase() {
            try {
                const { data: userData, error: userError } = await supabaseClient
                    .from('profiles')
                    .select('user_type, fabrication_areas')
                    .eq('id', AppState.currentUser.id)
                    .single();
                
                if (userError || userData.user_type !== 'fabricator') {
                    console.log('Usuário não é fabricante ou erro ao verificar tipo');
                    return [];
                }
                
                let capabilities = [];
                if (userData.fabrication_areas && Array.isArray(userData.fabrication_areas)) {
                    capabilities = userData.fabrication_areas;
                } else {
                    capabilities = ["cnc-machining", "laser-cutting", "3d-printing", "machining", "welding", "wood-fabrication", "metal-bending"];
                }
                
                let query = supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('status', 'pending');
                
                if (capabilities && capabilities.length > 0) {
                    const orConditions = capabilities.map(method => `method.eq.${method}`).join(',');
                    query = query.or(orConditions);
                }
                
                const { data: projects, error } = await query.order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao carregar projetos:', error);
                    return [];
                }
                
                const formattedRequests = [];
                for (let project of projects) {
                    let clientName = 'Cliente';
                    try {
                        const { data: profile } = await supabaseClient
                            .from('profiles')
                            .select('name')
                            .eq('id', project.client_id)
                            .single();
                        
                        if (profile) {
                            clientName = profile.name;
                        }
                    } catch (error) {
                        console.error('Erro ao buscar perfil do cliente:', error);
                    }
                    
                    formattedRequests.push({
                        id: project.id,
                        name: project.name,
                        clientId: project.client_id,
                        clientName: clientName,
                        fileName: project.file_name,
                        fileSize: project.file_size,
                        fileUrl: project.file_url,
                        date: project.created_at.split('T')[0],
                        dueDate: project.due_date,
                        method: project.method,
                        material: project.material,
                        quantity: project.quantity,
                        description: project.description,
                        status: project.status
                    });
                }
                
                AppState.fabricatorRequests = formattedRequests;
                return formattedRequests;
            } catch (error) {
                console.error('Erro ao carregar solicitações:', error);
                return [];
            }
        }

        async function saveProjectToSupabase(projectData, fileUrl) {
            try {
                const { data, error } = await supabaseClient
                    .from('projects')
                    .insert([{
                        client_id: AppState.currentUser.id,
                        name: projectData.name,
                        file_name: projectData.fileName,
                        file_size: projectData.fileSize,
                        file_url: fileUrl,
                        due_date: projectData.dueDate,
                        method: projectData.method,
                        material: projectData.material,
                        quantity: projectData.quantity,
                        description: projectData.description,
                        status: 'pending'
                    }])
                    .select();
                
                if (error) throw error;
                
                const { data: profileData } = await supabaseClient
                    .from('profiles')
                    .select('user_type')
                    .eq('id', AppState.currentUser.id)
                    .single();
                
                if (profileData && profileData.user_type !== 'fabricator') {
                    await supabaseClient
                        .from('profiles')
                        .update({ user_type: 'client' })
                        .eq('id', AppState.currentUser.id);
                }
                
                return data[0];
            } catch (error) {
                console.error('Erro ao salvar projeto:', error);
                throw error;
            }
        }

        async function submitQuoteToSupabase(quoteData, pdfFile = null) {
            try {
                console.log('Iniciando upload do orçamento para projeto:', quoteData.projectId);
                
                let pdfUrl = null;
                let pdfFileName = null;

                if (pdfFile) {
                    console.log('Fazendo upload do PDF...');
                    try {
                        const pdfUploadResult = await uploadPdfToSupabase(pdfFile, quoteData.projectId);
                        pdfUrl = pdfUploadResult.pdfUrl;
                        pdfFileName = pdfUploadResult.pdfFileName;
                        console.log('PDF upload concluído:', pdfUrl);
                    } catch (pdfError) {
                        console.error('Erro no upload do PDF, enviando orçamento sem PDF:', pdfError);
                    }
                }

                console.log('Inserindo orçamento no banco de dados...');
                const { data, error } = await supabaseClient
                    .from('quotes')
                    .insert([{
                        project_id: quoteData.projectId,
                        fabricator_id: AppState.currentUser.id,
                        amount: quoteData.amount,
                        lead_time: quoteData.leadTime,
                        payment_terms: quoteData.paymentTerms,
                        notes: quoteData.notes,
                        pdf_url: pdfUrl,
                        pdf_file_name: pdfFileName,
                        status: 'pending'
                    }])
                    .select();
                
                if (error) {
                    console.error('Erro ao inserir orçamento:', error);
                    throw new Error(`Erro no banco de dados: ${error.message}`);
                }
                
                console.log('Atualizando status do projeto...');
                const { error: updateError } = await supabaseClient
                    .from('projects')
                    .update({ status: 'quoted' })
                    .eq('id', quoteData.projectId);
                
                if (updateError) {
                    console.error('Erro ao atualizar projeto:', updateError);
                }
                
                console.log('Orçamento enviado com sucesso!');
                return data[0];
                
            } catch (error) {
                console.error('Erro detalhado no submitQuoteToSupabase:', error);
                throw error;
            }
        }

        async function uploadPdfToSupabase(pdfFile, projectId) {
            try {
                const fileExt = pdfFile.name.split('.').pop();
                const fileName = `quote-${projectId}-${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
                const filePath = `quote-pdfs/${fileName}`;
                
                const { data: buckets } = await supabaseClient.storage.listBuckets();
                const bucketExists = buckets.some(bucket => bucket.name === 'quote-pdfs');
                
                if (!bucketExists) {
                    console.log('Bucket quote-pdfs não existe, criando...');
                    const { error: createError } = await supabaseClient.storage.createBucket('quote-pdfs', {
                        public: true,
                        allowedMimeTypes: ['application/pdf']
                    });
                    
                    if (createError) {
                        console.error('Erro ao criar bucket:', createError);
                        const fallbackPath = `project-files/${fileName}`;
                        const { data: fallbackData, error: fallbackError } = await supabaseClient.storage
                            .from('project-files')
                            .upload(fallbackPath, pdfFile, {
                                cacheControl: '3600',
                                upsert: false
                            });
                        
                        if (fallbackError) throw fallbackError;
                        
                        const { data: urlData } = supabaseClient.storage
                            .from('project-files')
                            .getPublicUrl(fallbackPath);
                        
                        return {
                            pdfFileName: pdfFile.name,
                            pdfUrl: urlData.publicUrl
                        };
                    }
                }
                
                const { data, error } = await supabaseClient.storage
                    .from('quote-pdfs')
                    .upload(filePath, pdfFile, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    console.log('Erro no upload para quote-pdfs, tentando project-files...');
                    const fallbackPath = `project-files/${fileName}`;
                    const { data: fallbackData, error: fallbackError } = await supabaseClient.storage
                        .from('project-files')
                        .upload(fallbackPath, pdfFile, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (fallbackError) throw fallbackError;
                    
                    const { data: urlData } = supabaseClient.storage
                        .from('project-files')
                        .getPublicUrl(fallbackPath);
                    
                    return {
                        pdfFileName: pdfFile.name,
                        pdfUrl: urlData.publicUrl
                    };
                }
                
                const { data: urlData } = supabaseClient.storage
                    .from('quote-pdfs')
                    .getPublicUrl(filePath);
                
                return {
                    pdfFileName: pdfFile.name,
                    pdfUrl: urlData.publicUrl
                };
            } catch (error) {
                console.error('Erro no upload do PDF:', error);
                throw error;
            }
        }

        async function uploadFileToSupabase(file) {
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
                const filePath = `project-files/${fileName}`;
                
                const { data: buckets } = await supabaseClient.storage.listBuckets();
                const bucketExists = buckets.some(bucket => bucket.name === 'project-files');
                
                if (!bucketExists) {
                    console.log('Bucket não existe, criando...');
                    await supabaseClient.storage.createBucket('project-files', {
                        public: true,
                        allowedMimeTypes: [
                            'application/octet-stream',
                            'application/pdf',
                            'image/*',
                            'model/stl',
                            'application/step',
                            'application/iges',
                            'application/dxf',
                            'application/dwg'
                        ]
                    });
                }
                
                const { data, error } = await supabaseClient.storage
                    .from('project-files')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) throw error;
                
                const { data: urlData } = supabaseClient.storage
                    .from('project-files')
                    .getPublicUrl(filePath);
                
                return {
                    fileName: file.name,
                    fileSize: `${(file.size / 1024 / 1024).toFixed(2)} MB`,
                    fileUrl: urlData.publicUrl
                };
            } catch (error) {
                console.error('Erro no upload do arquivo:', error);
                throw error;
            }
        }

        // ==================== FUNÇÕES UTILITÁRIAS DO MARKETPLACE ====================
        const utils = {
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(amount);
            },
            
            formatDate: (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            },
            
            formatDateTime: (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) + ' - ' + date.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit'
                });
            },
            
            generateId: () => {
                return Date.now() + Math.floor(Math.random() * 1000);
            },
            
            showNotification: (message, type = 'info', duration = 5000) => {
                const notificationArea = document.getElementById('notification-area');
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;
                
                notificationArea.appendChild(notification);
                
                setTimeout(() => notification.classList.add('active'), 10);
                
                setTimeout(() => {
                    notification.classList.remove('active');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            },
            
            openModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            },
            
            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            },
            
            closeAllModals: () => {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
                document.body.style.overflow = 'auto';
            },
            
            getStatusBadge: (status) => {
                const statusMap = {
                    'pending': { class: 'status-pending', text: 'Orçamentos Pendentes' },
                    'quoted': { class: 'status-quoted', text: 'Orçamentos Recebidos' },
                    'accepted': { class: 'status-in-progress', text: 'Orçamento Aceito' },
                    'in-progress': { class: 'status-in-progress', text: 'Em Andamento' },
                    'completed': { class: 'status-completed', text: 'Concluído' },
                    'cancelled': { class: 'status-cancelled', text: 'Cancelado' }
                };
                
                const statusInfo = statusMap[status] || { class: 'status-pending', text: 'Pendente' };
                return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
            },
            
            getMethodIcon: (method) => {
                const iconMap = {
                    'cnc-machining': 'microchip',
                    'laser-cutting': 'bolt',
                    '3d-printing': 'cube',
                    'prototyping': 'flask',
                    'wood-fabrication': 'hammer',
                    'welding': 'wrench',
                    'sheet-metal': 'layer-group',
                    'machining': 'cogs',
                    'metal-bending': 'compress-alt'
                };
                return iconMap[method] || 'cogs';
            }
        };

        // ==================== APLICAÇÃO DO MARKETPLACE ====================
        const app = {
            init: () => {
                app.setupEventListeners();
                app.updateUI();
                app.showPage('home');
                // Notificação de boas-vindas removida daqui para evitar duplicidade
            },
            
            setupEventListeners: () => {
                // Navegação
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = link.id.replace('nav-', '');
                        
                        app.showPage(page);
                    });
                });
                
                document.getElementById('logo').addEventListener('click', () => app.showPage('home'));
                
                // Botão "Solicitar Orçamento" na hero section - rola até a seção de upload
                document.getElementById('get-quote-btn').addEventListener('click', () => {
                    app.showPage('home');
                    setTimeout(() => {
                        document.getElementById('upload-section').scrollIntoView({ behavior: 'smooth' });
                        document.getElementById('upload-content').click();
                    }, 100);
                });
                
                // Botão "Métodos de fabricação" na hero section - sempre vai para a página de métodos
                document.getElementById('browse-manufacturers-btn').addEventListener('click', () => {
                    app.showPage('methods');
                });
                
                // Troca de abas
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        app.switchTab(tabId);
                    });
                });
                
                // Upload de arquivos
                const uploadArea = document.getElementById('upload-area');
                const fileInput = document.getElementById('file-input');
                const uploadContent = document.getElementById('upload-content');
                
                if (uploadContent) {
                    uploadContent.addEventListener('click', () => fileInput.click());
                }
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    app.handleFileUpload(files);
                });
                fileInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    app.handleFileUpload(files);
                });
                
                // Upload de PDF no modal de orçamento
                const pdfUploadArea = document.getElementById('pdf-upload-area');
                const pdfUploadContent = document.getElementById('pdf-upload-content');
                const pdfInput = document.getElementById('quote-pdf-input');
                
                if (pdfUploadContent) {
                    pdfUploadContent.addEventListener('click', () => pdfInput.click());
                }
                
                pdfUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    pdfUploadArea.classList.add('dragover');
                });
                
                pdfUploadArea.addEventListener('dragleave', () => {
                    pdfUploadArea.classList.remove('dragover');
                });
                
                pdfUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    pdfUploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'application/pdf') {
                        app.handlePdfUpload(files[0]);
                    } else {
                        utils.showNotification('Por favor, selecione apenas arquivos PDF', 'error');
                    }
                });
                
                pdfInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files.length > 0) {
                        app.handlePdfUpload(files[0]);
                    }
                });
                
                // Botão para remover PDF
                const pdfRemoveBtn = document.getElementById('pdf-remove-btn');
                if (pdfRemoveBtn) {
                    pdfRemoveBtn.addEventListener('click', () => {
                        app.removePdfFile();
                    });
                }
                
                // Submissões de formulários
                document.getElementById('project-form').addEventListener('submit', app.handleProjectSubmit);
                document.getElementById('quote-form').addEventListener('submit', app.handleQuoteSubmit);
                document.getElementById('capabilities-form').addEventListener('submit', app.handleCapabilitiesSubmit);
                
                // Cliques em botões
                document.getElementById('new-project-btn').addEventListener('click', () => {
                    app.showPage('home');
                    setTimeout(() => {
                        document.getElementById('upload-section').scrollIntoView({ behavior: 'smooth' });
                        document.getElementById('upload-content').click();
                    }, 100);
                });
                
                document.getElementById('update-capabilities-btn').addEventListener('click', () => app.openCapabilitiesModal());
                
                // Botões de fechar modal
                document.querySelectorAll('.close-modal').forEach(button => {
                    button.addEventListener('click', utils.closeAllModals);
                });
                
                // Fechar modal ao clicar fora
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            utils.closeAllModals();
                        }
                    });
                });
                
                // Cards de método (agora apenas para abrir modal)
                document.querySelectorAll('.method-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const method = card.getAttribute('data-method');
                        app.openMethodDetailModal(method);
                    });
                });
                
                // Event listeners para o chat
                document.getElementById('send-chat-message').addEventListener('click', app.sendChatMessage);
                
                document.getElementById('chat-message-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        app.sendChatMessage();
                    }
                });
                
                // Event delegation para botões das tabelas
                document.addEventListener('click', (e) => {
                    // Botão "Ver Orçamentos"
                    if (e.target.classList.contains('view-quotes-btn') || e.target.closest('.view-quotes-btn')) {
                        const button = e.target.classList.contains('view-quotes-btn') ? e.target : e.target.closest('.view-quotes-btn');
                        const projectId = button.getAttribute('data-project-id');
                        if (projectId) {
                            app.openQuoteDetailModal(projectId);
                        }
                    }
                    
                    // Botão "Cancelar Projeto"
                    if (e.target.classList.contains('cancel-project-btn') || e.target.closest('.cancel-project-btn')) {
                        const button = e.target.classList.contains('cancel-project-btn') ? e.target : e.target.closest('.cancel-project-btn');
                        const projectId = button.getAttribute('data-project-id');
                        if (projectId) {
                            app.cancelProject(projectId);
                        }
                    }
                    
                    // Botão "Chat"
                    if (e.target.classList.contains('open-chat-btn') || e.target.closest('.open-chat-btn')) {
                        const button = e.target.classList.contains('open-chat-btn') ? e.target : e.target.closest('.open-chat-btn');
                        const projectId = button.getAttribute('data-project-id');
                        if (projectId) {
                            app.openChatModal(projectId);
                        }
                    }
                    
                    // Botão "Enviar Orçamento" (fabricante)
                    if (e.target.classList.contains('submit-quote-btn') || e.target.closest('.submit-quote-btn')) {
                        const button = e.target.classList.contains('submit-quote-btn') ? e.target : e.target.closest('.submit-quote-btn');
                        const projectId = button.getAttribute('data-id');
                        const project = AppState.fabricatorRequests.find(r => r.id.toString() === projectId.toString());
                        if (project) {
                            app.openQuoteModal(project);
                        } else {
                            utils.showNotification('Solicitação não encontrada.', 'error');
                        }
                    }
                    
                    // Botão "Download" do projeto (fabricante)
                    if (e.target.classList.contains('download-project-btn') || e.target.closest('.download-project-btn')) {
                        const button = e.target.classList.contains('download-project-btn') ? e.target : e.target.closest('.download-project-btn');
                        const fileUrl = button.getAttribute('data-file-url');
                        const fileName = button.getAttribute('data-file-name');
                        if (fileUrl) {
                            app.downloadProjectFile(fileUrl, fileName);
                        } else {
                            utils.showNotification('Arquivo não disponível para download', 'error');
                        }
                    }
                    
                    // Botão "Atualizar Progresso" (fabricante)
                    if (e.target.classList.contains('update-progress-btn') || e.target.closest('.update-progress-btn')) {
                        const button = e.target.classList.contains('update-progress-btn') ? e.target : e.target.closest('.update-progress-btn');
                        const jobId = button.getAttribute('data-job-id');
                        app.updateJobProgress(jobId);
                    }
                });
            },
            
            updateUI: () => {
                app.updateDashboardStats();
                
                const currentPage = document.querySelector('.page-container.active').id.replace('-page', '');
                if (currentPage) {
                    app.loadPageContent(currentPage);
                }
            },
            
            showPage: (pageName) => {
                document.querySelectorAll('.page-container').forEach(page => {
                    page.classList.remove('active');
                });
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                const page = document.getElementById(`${pageName}-page`);
                if (page) {
                    page.classList.add('active');
                    document.getElementById(`nav-${pageName}`).classList.add('active');
                    
                    app.loadPageContent(pageName);
                    
                    window.scrollTo(0, 0);
                }
            },
            
            switchTab: (tabId) => {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const selectedTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }
                
                const tabContent = document.getElementById(tabId);
                if (tabContent) {
                    tabContent.classList.add('active');
                }
                
                if (tabId.startsWith('client-')) {
                    app.loadClientTabContent(tabId.replace('client-', ''));
                } else if (tabId.startsWith('fabricator-')) {
                    app.loadFabricatorTabContent(tabId.replace('fabricator-', ''));
                }
            },
            
            loadPageContent: (pageName) => {
                switch(pageName) {
                    case 'client':
                        app.loadClientDashboard();
                        break;
                    case 'fabricator':
                        app.loadFabricatorDashboard();
                        break;
                    case 'methods':
                        break;
                    default:
                        break;
                }
            },
            
            updateDashboardStats: () => {
                if (AppState.currentUser.type === 'client') {
                    const clientProjects = AppState.projects.filter(p => p.clientId === AppState.currentUser.id);
                    const totalProjects = clientProjects.length;
                    const pendingQuotes = clientProjects.filter(p => p.status === 'pending').length;
                    const activeProjects = clientProjects.filter(p => p.status === 'in-progress' || p.status === 'accepted').length;
                    const completedProjects = clientProjects.filter(p => p.status === 'completed').length;
                    
                    document.getElementById('total-projects-count').textContent = totalProjects;
                    document.getElementById('pending-quotes-count').textContent = pendingQuotes;
                    document.getElementById('active-projects-count').textContent = activeProjects;
                    document.getElementById('completed-projects-count').textContent = completedProjects;
                    
                    document.getElementById('total-projects-stat').addEventListener('click', () => {
                        app.showPage('client');
                        app.switchTab('client-all');
                    });
                    document.getElementById('pending-quotes-stat').addEventListener('click', () => {
                        app.showPage('client');
                        app.switchTab('client-pending');
                    });
                    document.getElementById('active-projects-stat').addEventListener('click', () => {
                        app.showPage('client');
                        app.switchTab('client-active');
                    });
                    document.getElementById('completed-projects-stat').addEventListener('click', () => {
                        app.showPage('client');
                        app.switchTab('client-completed');
                    });
                } else {
                    app.loadFabricatorQuotesFromSupabase().then(() => {
                        app.updateFabricatorStats();
                    });
                    app.loadFabricatorJobs();
                }
            },
            
            updateFabricatorStats: () => {
                const activeRequests = AppState.fabricatorRequests.filter(r => r.status === 'pending').length;
                const quotesSubmitted = AppState.fabricatorQuotes.filter(q => q.fabricatorId === AppState.currentUser.id).length;
                const jobsActive = AppState.fabricatorJobs.filter(j => j.status === 'in-progress' || j.status === 'accepted').length;
                const jobsCompleted = AppState.fabricatorJobs.filter(j => j.status === 'completed').length;
                
                document.getElementById('active-requests-count').textContent = activeRequests;
                document.getElementById('quotes-submitted-count').textContent = quotesSubmitted;
                document.getElementById('jobs-completed-count').textContent = jobsActive;
                document.getElementById('completed-jobs-count').textContent = jobsCompleted;
                
                document.getElementById('active-requests-stat').addEventListener('click', () => {
                    app.showPage('fabricator');
                    app.switchTab('fabricator-new');
                });
                document.getElementById('quotes-submitted-stat').addEventListener('click', () => {
                    app.showPage('fabricator');
                    app.switchTab('fabricator-quotes');
                });
                document.getElementById('jobs-completed-stat').addEventListener('click', () => {
                    app.showPage('fabricator');
                    app.switchTab('fabricator-active');
                });
                document.getElementById('completed-jobs-stat').addEventListener('click', () => {
                    app.showPage('fabricator');
                    app.switchTab('fabricator-completed');
                });
            },
            
            loadClientDashboard: () => {
                app.loadClientTabContent('all');
            },
            
            loadClientTabContent: async (tab) => {
                await loadClientProjectsFromSupabase();
                
                const clientProjects = AppState.projects.filter(p => p.clientId === AppState.currentUser.id);
                
                switch(tab) {
                    case 'all':
                        app.renderClientProjectsTable(clientProjects, 'client-projects-table');
                        break;
                    case 'pending':
                        const pending = clientProjects.filter(p => p.status === 'pending');
                        app.renderClientProjectsTable(pending, 'client-pending-table');
                        break;
                    case 'active':
                        const active = clientProjects.filter(p => p.status === 'in-progress' || p.status === 'accepted');
                        app.renderClientProjectsTable(active, 'client-active-table');
                        break;
                    case 'completed':
                        const completed = clientProjects.filter(p => p.status === 'completed');
                        app.renderClientProjectsTable(completed, 'client-completed-table');
                        break;
                }
            },
            
            renderClientProjectsTable: (projects, tbodyId) => {
                const container = document.getElementById(tbodyId);
                container.innerHTML = '';
                
                if (projects.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--light-gray);">
                                <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                <p>Nenhum projeto encontrado nesta categoria.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                projects.forEach(project => {
                    const row = document.createElement('tr');
                    const quotesCount = project.quotes.length;
                    
                    let actions = '';
                    
                    if (project.status === 'pending') {
                        actions = `
                            <div class="action-buttons">
                                ${quotesCount > 0 ? `<button class="btn btn-small btn-primary view-quotes-btn" data-project-id="${project.id}">Ver Orçamentos (${quotesCount})</button>` : ''}
                                <button class="btn btn-small btn-danger cancel-project-btn" data-project-id="${project.id}">Cancelar</button>
                            </div>
                        `;
                    } else if (project.status === 'in-progress' || project.status === 'accepted') {
                        actions = `
                            <div class="action-buttons">
                                <button class="btn btn-small btn-accent open-chat-btn" data-project-id="${project.id}">
                                    <i class="fas fa-comments"></i> ${project.unreadMessages > 0 ? `(${project.unreadMessages})` : 'Chat'}
                                </button>
                                ${quotesCount > 0 ? `<button class="btn btn-small btn-primary view-quotes-btn" data-project-id="${project.id}">Ver Orçamentos (${quotesCount})</button>` : ''}
                            </div>
                        `;
                    } else if (project.status === 'completed' || project.status === 'cancelled') {
                        actions = `
                            <div class="action-buttons">
                                <button class="btn btn-small btn-outline view-quotes-btn" data-project-id="${project.id}">Ver Detalhes</button>
                            </div>
                        `;
                    }
                    
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <strong style="color: white;">${project.name}</strong>
                                ${project.unreadMessages > 0 ? `<span class="unread-badge">${project.unreadMessages}</span>` : ''}
                            </div>
                        </td>
                        <td>${utils.formatDate(project.date)}</td>
                        <td>
                            <div class="file-info">
                                <i class="fas fa-${utils.getMethodIcon(project.method)}"></i>
                                <span>${project.method}</span>
                            </div>
                        </td>
                        <td>${quotesCount}</td>
                        <td>${utils.getStatusBadge(project.status)}</td>
                        <td>${actions}</td>
                    `;
                    
                    container.appendChild(row);
                });
            },
            
            loadFabricatorDashboard: async () => {
                try {
                    const requests = await loadFabricatorRequestsFromSupabase();
                    AppState.fabricatorRequests = requests;
                    
                    await app.loadFabricatorQuotesFromSupabase();
                    await app.loadFabricatorJobs();
                    
                    app.loadFabricatorTabContent('new');
                    app.updateFabricatorStats();
                    
                } catch (error) {
                    console.error('Erro ao carregar dashboard do fabricante:', error);
                    utils.showNotification('Erro ao carregar dashboard. Tente novamente.', 'error');
                }
            },
            
            loadFabricatorJobs: async () => {
                try {
                    console.log('Carregando trabalhos para o fabricante:', AppState.currentUser.id, AppState.currentUser.name);
                    
                    const { data: userData } = await supabaseClient
                        .from('profiles')
                        .select('user_type')
                        .eq('id', AppState.currentUser.id)
                        .single();
                        
                    if (!userData || userData.user_type !== 'fabricator') {
                        console.log('Usuário não é fabricante, retornando array vazio');
                        AppState.fabricatorJobs = [];
                        return [];
                    }
                    
                    const { data: jobs, error } = await supabaseClient
                        .from('jobs')
                        .select(`
                            *,
                            projects:project_id (name, client_id, due_date),
                            quotes:quote_id (amount, fabricator_id, status)
                        `)
                        .eq('fabricator_id', AppState.currentUser.id)
                        .in('status', ['in-progress', 'accepted', 'completed']);
                    
                    if (error) {
                        console.error('Erro na query de jobs:', error);
                        throw error;
                    }
                    
                    console.log(`Encontrados ${jobs?.length || 0} jobs para o fabricante ${AppState.currentUser.id}`);
                    
                    const formattedJobs = [];
                    for (let job of jobs || []) {
                        let clientName = 'Cliente';
                        try {
                            const { data: clientProfile } = await supabaseClient
                                .from('profiles')
                                .select('name')
                                .eq('id', job.projects?.client_id)
                                .single();
                            
                            if (clientProfile) {
                                clientName = clientProfile.name;
                            }
                        } catch (error) {
                            console.error('Erro ao buscar nome do cliente:', error);
                        }
                        
                        if (job.quotes?.fabricator_id !== AppState.currentUser.id) {
                            console.warn(`Job ${job.id} tem quote de fabricante diferente! Ignorando...`);
                            continue;
                        }
                        
                        const formattedJob = {
                            id: job.id,
                            projectId: job.project_id,
                            projectName: job.projects?.name || 'Projeto',
                            clientId: job.projects?.client_id,
                            clientName: clientName,
                            quoteId: job.quote_id,
                            fabricatorId: job.fabricator_id,
                            fabricatorName: AppState.currentUser.name,
                            startDate: job.start_date?.split('T')[0] || new Date().toISOString().split('T')[0],
                            dueDate: job.projects?.due_date || new Date().toISOString().split('T')[0],
                            status: job.status,
                            progress: job.progress || 10,
                            completedDate: job.completed_at?.split('T')[0] || null,
                            rating: job.rating || null,
                            unreadMessages: 0
                        };
                        
                        const { count, error: msgError } = await supabaseClient
                            .from('messages')
                            .select('*', { count: 'exact', head: true })
                            .eq('project_id', formattedJob.projectId)
                            .eq('read', false)
                            .neq('sender_id', AppState.currentUser.id);
                        
                        if (!msgError && count) {
                            formattedJob.unreadMessages = count;
                        }
                        
                        formattedJobs.push(formattedJob);
                    }
                    
                    AppState.fabricatorJobs = formattedJobs;
                    console.log(`Jobs formatados para o fabricante: ${formattedJobs.length}`);
                    
                } catch (error) {
                    console.error('Erro ao carregar trabalhos:', error);
                    AppState.fabricatorJobs = [];
                    return [];
                }
            },
            
            loadFabricatorTabContent: (tab) => {
                switch(tab) {
                    case 'new':
                        const pendingRequests = AppState.fabricatorRequests.filter(r => r.status === 'pending');
                        app.renderFabricatorRequestsTable(pendingRequests);
                        break;
                    case 'quotes':
                        const fabricatorQuotes = AppState.fabricatorQuotes.filter(q => q.fabricatorId === AppState.currentUser.id);
                        app.renderFabricatorQuotesTable(fabricatorQuotes);
                        break;
                    case 'active':
                        const activeJobs = AppState.fabricatorJobs.filter(j => j.status === 'in-progress' || j.status === 'accepted');
                        app.renderFabricatorActiveJobsTable(activeJobs);
                        break;
                    case 'completed':
                        const completedJobs = AppState.fabricatorJobs.filter(j => j.status === 'completed');
                        app.renderFabricatorCompletedTable(completedJobs);
                        break;
                }
            },
            
            renderFabricatorRequestsTable: (requests) => {
                const container = document.getElementById('fabricator-new-requests-table');
                container.innerHTML = '';
                
                if (requests.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--light-gray);">
                                <i class="fas fa-briefcase" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                <p>Nenhuma nova solicitação disponível no momento.</p>
                                <p style="font-size: 0.9rem; margin-top: 10px;">Verifique suas capacidades de fabricação ou tente novamente mais tarde.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                requests.forEach(request => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong style="color: white;">${request.name}</strong></td>
                        <td>${request.clientName}</td>
                        <td>${request.method}</td>
                        <td>${request.material}</td>
                        <td>${utils.formatDate(request.dueDate)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-small btn-secondary download-project-btn" data-file-url="${request.fileUrl}" data-file-name="${request.fileName}">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button class="btn btn-small btn-primary submit-quote-btn" data-id="${request.id}">
                                    <i class="fas fa-paper-plane"></i> Orçar
                                </button>
                            </div>
                        </td>
                    `;
                    container.appendChild(row);
                });
            },
            
            renderFabricatorQuotesTable: (quotes) => {
                const container = document.getElementById('fabricator-quotes-table');
                container.innerHTML = '';
                
                if (quotes.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--light-gray);">
                                <i class="fas fa-file-signature" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                <p>Nenhum orçamento enviado ainda. Comece enviando um orçamento para um projeto!</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                quotes.forEach(quote => {
                    const row = document.createElement('tr');
                    
                    let statusBadge = '';
                    switch(quote.status) {
                        case 'pending':
                            statusBadge = '<span class="status-badge status-pending">Pendente</span>';
                            break;
                        case 'accepted':
                            statusBadge = '<span class="status-badge status-in-progress">Aceito</span>';
                            break;
                        case 'rejected':
                            statusBadge = '<span class="status-badge status-cancelled">Rejeitado</span>';
                            break;
                        case 'completed':
                            statusBadge = '<span class="status-badge status-completed">Concluído</span>';
                            break;
                    }
                    
                    row.innerHTML = `
                        <td><strong style="color: white;">${quote.projectName}</strong></td>
                        <td>${quote.clientName}</td>
                        <td>${utils.formatCurrency(quote.amount)}</td>
                        <td>${utils.formatDate(quote.date)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-small btn-outline view-quote" data-id="${quote.id}">Ver</button>
                            </div>
                        </td>
                    `;
                    
                    container.appendChild(row);
                });
                
                container.querySelectorAll('.view-quote').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const quoteId = e.target.getAttribute('data-id');
                        app.openFabricatorQuoteDetailModal(quoteId);
                    });
                });
            },
            
            renderFabricatorActiveJobsTable: (jobs) => {
                const container = document.getElementById('fabricator-active-jobs-table');
                container.innerHTML = '';
                
                const fabricatorJobs = jobs.filter(job => job.fabricatorId === AppState.currentUser.id);
                
                if (fabricatorJobs.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--light-gray);">
                                <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                <p>Nenhum trabalho ativo. Orçamentos precisam ser aceitos pelos clientes primeiro.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                fabricatorJobs.forEach(job => {
                    const row = document.createElement('tr');
                    const project = AppState.projects.find(p => p.id === job.projectId);
                    
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <strong style="color: white;">${job.projectName}</strong>
                                ${job.unreadMessages > 0 ? `<span class="unread-badge">${job.unreadMessages}</span>` : ''}
                            </div>
                        </td>
                        <td>${job.clientName}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 60px; background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px;">
                                    <div style="width: ${job.progress}%; height: 8px; background: var(--primary); border-radius: 4px;"></div>
                                </div>
                                <span style="color: white;">${job.progress}%</span>
                            </div>
                        </td>
                        <td>${utils.formatDate(job.dueDate)}</td>
                        <td><span class="status-badge status-in-progress">Em Andamento</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-small btn-outline update-progress-btn" data-job-id="${job.id}">
                                    <i class="fas fa-chart-line"></i> Progresso
                                </button>
                                <button class="btn btn-small btn-accent open-chat-btn" data-project-id="${job.projectId}">
                                    <i class="fas fa-comments"></i> ${job.unreadMessages > 0 ? `(${job.unreadMessages})` : 'Chat'}
                                </button>
                            </div>
                        </td>
                    `;
                    container.appendChild(row);
                });
            },
            
            renderFabricatorCompletedTable: (jobs) => {
                const container = document.getElementById('fabricator-completed-table');
                container.innerHTML = '';
                
                if (jobs.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--light-gray);">
                                <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                <p>Nenhum trabalho concluído ainda.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                jobs.forEach(job => {
                    const row = document.createElement('tr');
                    
                    let stars = '';
                    if (job.rating) {
                        for (let i = 0; i < 5; i++) {
                            stars += i < job.rating ? '<i class="fas fa-star" style="color: #fbbf24;"></i>' : '<i class="far fa-star" style="color: #d1d5db;"></i>';
                        }
                    } else {
                        stars = 'Não avaliado';
                    }
                    
                    const quote = AppState.fabricatorQuotes.find(q => q.id === job.quoteId);
                    
                    row.innerHTML = `
                        <td><strong style="color: white;">${job.projectName}</strong></td>
                        <td>${job.clientName}</td>
                        <td>${utils.formatDate(job.completedDate || job.startDate)}</td>
                        <td>${quote ? utils.formatCurrency(quote.amount) : 'N/A'}</td>
                        <td>${stars}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-small btn-outline view-job" data-id="${job.id}">Detalhes</button>
                            </div>
                        </td>
                    `;
                    
                    container.appendChild(row);
                });
                
                container.querySelectorAll('.view-job').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const jobId = e.target.getAttribute('data-id');
                        utils.showNotification(`Os detalhes do trabalho seriam abertos aqui.`, 'info');
                    });
                });
            },
            
            loadFabricatorQuotesFromSupabase: async () => {
                try {
                    const { data: userData, error: userError } = await supabaseClient
                        .from('profiles')
                        .select('user_type')
                        .eq('id', AppState.currentUser.id)
                        .single();
                    
                    if (userError || userData?.user_type !== 'fabricator') {
                        console.log('Usuário não é fabricante, retornando array vazio');
                        AppState.fabricatorQuotes = [];
                        return [];
                    }
                    
                    const { data: quotes, error } = await supabaseClient
                        .from('quotes')
                        .select('*')
                        .eq('fabricator_id', AppState.currentUser.id)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    const formattedQuotes = [];
                    for (let quote of quotes || []) {
                        let projectName = 'Projeto';
                        let clientId = null;
                        
                        if (quote.project_id) {
                            const { data: project } = await supabaseClient
                                .from('projects')
                                .select('name, client_id')
                                .eq('id', quote.project_id)
                                .single();
                            
                            if (project) {
                                projectName = project.name;
                                clientId = project.client_id;
                            }
                        }
                        
                        let clientName = 'Cliente';
                        if (clientId) {
                            const { data: clientProfile } = await supabaseClient
                                .from('profiles')
                                .select('name')
                                .eq('id', clientId)
                                .single();
                            
                            if (clientProfile) {
                                clientName = clientProfile.name;
                            }
                        }
                        
                        formattedQuotes.push({
                            id: quote.id,
                            projectId: quote.project_id,
                            projectName: projectName,
                            clientId: clientId,
                            clientName: clientName,
                            fabricatorId: quote.fabricator_id,
                            fabricatorName: AppState.currentUser.name,
                            amount: parseFloat(quote.amount),
                            leadTime: quote.lead_time,
                            date: quote.created_at.split('T')[0],
                            status: quote.status,
                            notes: quote.notes,
                            paymentTerms: quote.payment_terms,
                            pdfUrl: quote.pdf_url,
                            pdfFileName: quote.pdf_file_name
                        });
                    }
                    
                    AppState.fabricatorQuotes = formattedQuotes;
                    return formattedQuotes;
                } catch (error) {
                    console.error('Erro ao carregar orçamentos:', error);
                    AppState.fabricatorQuotes = [];
                    return [];
                }
            },
            
            handleFileUpload: (files) => {
                if (files.length > 0) {
                    const uploadArea = document.getElementById('upload-area');
                    const uploadContent = document.getElementById('upload-content');
                    
                    if (uploadContent) {
                        uploadContent.innerHTML = `
                            <div class="upload-icon" style="color: var(--primary-light);">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3>${files.length} Arquivo${files.length > 1 ? 's' : ''} Selecionado${files.length > 1 ? 's' : ''}</h3>
                            <p style="color: var(--light-gray);">${Array.from(files).map(file => file.name).join(', ')}</p>
                            <button class="btn btn-outline" style="margin-top: 20px;" id="change-files-btn">Alterar Arquivos</button>
                        `;
                        
                        const changeFilesBtn = document.getElementById('change-files-btn');
                        if (changeFilesBtn) {
                            changeFilesBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                document.getElementById('file-input').click();
                            });
                        }
                    }
                    
                    utils.showNotification(`${files.length} arquivo${files.length > 1 ? 's' : ''} carregado${files.length > 1 ? 's' : ''} com sucesso.`, 'success');
                }
            },
            
            handlePdfUpload: (pdfFile) => {
                if (pdfFile.type !== 'application/pdf') {
                    utils.showNotification('Por favor, selecione apenas arquivos PDF', 'error');
                    return;
                }
                
                if (pdfFile.size > 10 * 1024 * 1024) {
                    utils.showNotification('O arquivo PDF deve ter no máximo 10MB', 'error');
                    return;
                }
                
                AppState.currentQuotePdfFile = pdfFile;
                
                const pdfFileInfo = document.getElementById('pdf-file-info');
                const pdfFileName = document.getElementById('pdf-file-name');
                const pdfUploadContent = document.getElementById('pdf-upload-content');
                
                if (pdfFileInfo && pdfFileName && pdfUploadContent) {
                    pdfFileName.textContent = pdfFile.name;
                    pdfFileInfo.style.display = 'block';
                    
                    pdfUploadContent.innerHTML = `
                        <div class="pdf-upload-icon" style="color: var(--primary-light);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4 style="color: white;">PDF Selecionado</h4>
                        <p style="color: var(--light-gray);">${pdfFile.name}</p>
                        <p style="font-size: 0.85rem; color: var(--light-gray); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> Clique para selecionar outro arquivo
                        </p>
                    `;
                }
                
                utils.showNotification('PDF carregado com sucesso!', 'success');
            },
            
            removePdfFile: () => {
                AppState.currentQuotePdfFile = null;
                
                const pdfFileInfo = document.getElementById('pdf-file-info');
                const pdfUploadContent = document.getElementById('pdf-upload-content');
                const pdfInput = document.getElementById('quote-pdf-input');
                
                if (pdfFileInfo && pdfUploadContent && pdfInput) {
                    pdfFileInfo.style.display = 'none';
                    pdfInput.value = '';
                    
                    pdfUploadContent.innerHTML = `
                        <div class="pdf-upload-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h4 style="color: white;">Clique para selecionar ou arraste um PDF</h4>
                        <p style="color: var(--light-gray);">Formato aceito: PDF (tamanho máximo: 10MB)</p>
                        <p style="font-size: 0.85rem; color: var(--light-gray); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> Você pode anexar um PDF detalhado com desenhos, especificações e condições
                        </p>
                    `;
                }
                
                utils.showNotification('PDF removido', 'info');
            },
            
            downloadProjectFile: (fileUrl, fileName) => {
                if (!fileUrl) {
                    utils.showNotification('Arquivo não disponível para download', 'error');
                    return;
                }
                
                const link = document.createElement('a');
                link.href = fileUrl;
                link.download = fileName || 'projeto.zip';
                link.target = '_blank';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                utils.showNotification(`Download do arquivo ${fileName || 'projeto'} iniciado`, 'success');
            },
            
            handleProjectSubmit: async (e) => {
                e.preventDefault();
                
                const fileInput = document.getElementById('file-input');
                if (!fileInput) {
                    utils.showNotification('Não foi possível encontrar o elemento de upload de arquivos. Por favor, recarregue a página.', 'error');
                    return;
                }
                
                const projectName = document.getElementById('project-name').value;
                const quantity = parseInt(document.getElementById('project-quantity').value);
                const material = document.getElementById('project-material').value;
                const method = document.getElementById('project-method').value;
                const dueDate = document.getElementById('project-due-date').value;
                const description = document.getElementById('project-description').value;
                
                const files = fileInput.files;
                if (files.length === 0) {
                    utils.showNotification('Por favor, selecione um arquivo', 'error');
                    return;
                }
                
                try {
                    utils.showNotification('Enviando projeto...', 'info');
                    
                    const fileData = await uploadFileToSupabase(files[0]);
                    
                    const projectData = {
                        name: projectName,
                        fileName: fileData.fileName,
                        fileSize: fileData.fileSize,
                        dueDate: dueDate,
                        method: method,
                        material: material,
                        quantity: quantity,
                        description: description
                    };
                    
                    const savedProject = await saveProjectToSupabase(projectData, fileData.fileUrl);
                    
                    const newProject = {
                        id: savedProject.id,
                        name: savedProject.name,
                        clientId: AppState.currentUser.id,
                        clientName: AppState.currentUser.name,
                        fileName: savedProject.file_name,
                        fileSize: savedProject.file_size,
                        fileUrl: savedProject.file_url,
                        date: savedProject.created_at.split('T')[0],
                        dueDate: savedProject.due_date,
                        method: savedProject.method,
                        material: savedProject.material,
                        quantity: savedProject.quantity,
                        description: savedProject.description,
                        status: savedProject.status,
                        quotes: [],
                        selectedQuoteId: null,
                        acceptedQuoteId: null,
                        unreadMessages: 0,
                        progress: 0
                    };
                    
                    AppState.projects.push(newProject);
                    
                    e.target.reset();
                    
                    const uploadContent = document.getElementById('upload-content');
                    if (uploadContent) {
                        uploadContent.innerHTML = `
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h3>Arraste e Solte Seus Arquivos Aqui</h3>
                            <p style="color: var(--light-gray);">ou clique para procurar arquivos no seu computador</p>
                            <div class="file-types">
                                <span class="file-type-tag">STL</span>
                                <span class="file-type-tag">STEP</span>
                                <span class="file-type-tag">IGES</span>
                                <span class="file-type-tag">DXF</span>
                                <span class="file-type-tag">DWG</span>
                                <span class="file-type-tag">PDF</span>
                            </div>
                        `;
                        
                        uploadContent.addEventListener('click', () => {
                            document.getElementById('file-input').click();
                        });
                    }
                    
                    fileInput.value = '';
                    
                    utils.showNotification(`Projeto "${projectName}" enviado com sucesso!`, 'success');
                    app.updateUI();
                    
                    if (AppState.currentUser.type === 'client') {
                        app.showPage('client');
                    }
                    
                } catch (error) {
                    console.error('Erro ao enviar projeto:', error);
                    utils.showNotification('Erro ao enviar projeto. Tente novamente.', 'error');
                }
            },
            
            handleQuoteSubmit: async (e) => {
                e.preventDefault();
                
                console.log('Iniciando envio de orçamento...');
                console.log('Projeto atual:', AppState.currentQuoteProject);
                
                const amount = parseFloat(document.getElementById('quote-amount').value);
                const leadTime = parseInt(document.getElementById('quote-lead-time').value);
                const paymentTerms = document.getElementById('quote-payment-terms').value;
                const notes = document.getElementById('quote-notes').value;
                
                if (!AppState.currentQuoteProject) {
                    console.error('Nenhum projeto selecionado para orçamento!');
                    utils.showNotification('Erro: Nenhum projeto selecionado.', 'error');
                    return;
                }
                
                try {
                    const quoteData = {
                        projectId: AppState.currentQuoteProject.id,
                        amount: amount,
                        leadTime: leadTime,
                        paymentTerms: paymentTerms,
                        notes: notes
                    };
                    
                    console.log('Dados do orçamento:', quoteData);
                    
                    const savedQuote = await submitQuoteToSupabase(quoteData, AppState.currentQuotePdfFile);
                    console.log('Orçamento salvo no Supabase:', savedQuote);
                    
                    const newQuote = {
                        id: savedQuote.id,
                        projectId: AppState.currentQuoteProject.id,
                        projectName: AppState.currentQuoteProject.name,
                        clientId: AppState.currentQuoteProject.clientId,
                        clientName: AppState.currentQuoteProject.clientName,
                        fabricatorId: AppState.currentUser.id,
                        fabricatorName: AppState.currentUser.name,
                        amount: amount,
                        leadTime: leadTime,
                        date: savedQuote.created_at.split('T')[0],
                        status: 'pending',
                        notes: notes,
                        paymentTerms: paymentTerms,
                        pdfUrl: savedQuote.pdf_url || null,
                        pdfFileName: savedQuote.pdf_file_name || null
                    };
                    
                    AppState.fabricatorQuotes.push(newQuote);
                    
                    const project = AppState.projects.find(p => p.id === AppState.currentQuoteProject.id);
                    if (project) {
                        project.quotes.push({
                            id: newQuote.id,
                            fabricatorId: newQuote.fabricatorId,
                            fabricatorName: newQuote.fabricatorName,
                            amount: newQuote.amount,
                            leadTime: newQuote.leadTime,
                            date: newQuote.date,
                            status: 'pending',
                            pdfUrl: newQuote.pdfUrl,
                            pdfFileName: newQuote.pdfFileName
                        });
                        
                        project.status = 'quoted';
                        
                        utils.showNotification(
                            `Orçamento enviado para ${project.clientName}! ${AppState.currentQuotePdfFile ? 'PDF anexado.' : ''} O cliente será notificado.`, 
                            'success'
                        );
                    }
                    
                    e.target.reset();
                    app.removePdfFile();
                    AppState.currentQuotePdfFile = null;
                    
                    utils.closeAllModals();
                    
                    utils.showNotification(
                        `Orçamento de ${utils.formatCurrency(amount)} enviado para "${AppState.currentQuoteProject.name}"!`, 
                        'success'
                    );
                    
                    app.updateUI();
                    
                } catch (error) {
                    console.error('Erro ao enviar orçamento:', error);
                    utils.showNotification('Erro ao enviar orçamento. Tente novamente.', 'error');
                }
            },
            
            handleCapabilitiesSubmit: (e) => {
                e.preventDefault();
                
                const methodCheckboxes = document.querySelectorAll('#capabilities-form input[type="checkbox"]:checked');
                const methods = Array.from(methodCheckboxes).map(cb => cb.value);
                
                const minOrder = parseFloat(document.getElementById('cap-min-order').value);
                const maxSize = document.getElementById('cap-max-size').value;
                const leadTime = parseInt(document.getElementById('cap-lead-time').value);
                const materials = document.getElementById('cap-materials').value;
                
                AppState.fabricatorCapabilities = {
                    methods: methods,
                    minOrder: minOrder,
                    maxSize: maxSize,
                    leadTime: leadTime,
                    materials: materials
                };
                
                utils.closeAllModals();
                
                utils.showNotification('Capacidades de fabricação atualizadas com sucesso!', 'success');
                
                app.updateUI();
            },
            
            openQuoteModal: (project) => {
                AppState.currentQuoteProject = {
                    ...project,
                    id: project.id.toString()
                };
                AppState.currentQuotePdfFile = null;
                
                document.getElementById('quote-project-name').value = project.name;
                
                const pdfFileInfo = document.getElementById('pdf-file-info');
                const pdfUploadContent = document.getElementById('pdf-upload-content');
                const pdfInput = document.getElementById('quote-pdf-input');
                
                if (pdfFileInfo && pdfUploadContent && pdfInput) {
                    pdfFileInfo.style.display = 'none';
                    pdfInput.value = '';
                    
                    pdfUploadContent.innerHTML = `
                        <div class="pdf-upload-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h4 style="color: white;">Clique para selecionar ou arraste um PDF</h4>
                        <p style="color: var(--light-gray);">Formato aceito: PDF (tamanho máximo: 10MB)</p>
                        <p style="font-size: 0.85rem; color: var(--light-gray); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> Você pode anexar um PDF detalhado com desenhos, especificações e condições
                        </p>
                    `;
                }
                
                document.getElementById('quote-form').reset();
                
                utils.openModal('quote-modal');
            },
            
            openProjectDetailModal: (projectId, isRequest = false) => {
                console.log('Abrindo modal de detalhes do projeto. ID:', projectId, 'isRequest:', isRequest);
                
                let project;
                
                if (isRequest) {
                    project = AppState.fabricatorRequests.find(r => r.id === projectId);
                } else {
                    project = AppState.projects.find(p => p.id === projectId);
                }
                
                if (!project) {
                    console.error('Projeto não encontrado! ID:', projectId);
                    utils.showNotification('Erro: Projeto não encontrado.', 'error');
                    return;
                }
                
                const modalContent = document.getElementById('project-detail-content');
                const modalFooter = document.querySelector('#project-detail-modal .modal-footer');
                const quotes = project.quotes || [];
                
                modalContent.innerHTML = `
                    <div class="card" style="box-shadow: none; border: none; padding: 0;">
                        <div class="card-header" style="border: none; padding: 0 0 20px 0;">
                            <div class="card-title">
                                <h3>${project.name}</h3>
                                <p style="color: var(--light-gray);">${project.description}</p>
                            </div>
                        </div>
                        
                        <div class="card-details">
                            <div class="detail-item">
                                <span class="detail-label">Cliente</span>
                                <span class="detail-value">${project.clientName}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Data de Publicação</span>
                                <span class="detail-value">${utils.formatDate(project.date)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Data de Entrega</span>
                                <span class="detail-value">${utils.formatDate(project.dueDate)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Status</span>
                                <span class="detail-value">${utils.getStatusBadge(project.status)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Método de Fabricação</span>
                                <span class="detail-value">${project.method}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Material</span>
                                <span class="detail-value">${project.material}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Quantidade</span>
                                <span class="detail-value">${project.quantity}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Arquivo</span>
                                <span class="detail-value">${project.fileName} (${project.fileSize})</span>
                            </div>
                        </div>
                        
                        ${quotes.length > 0 ? `
                        <div style="margin-top: 20px;">
                            <h4 style="color: white;">Orçamentos Recebidos (${quotes.length})</h4>
                            ${quotes.map(quote => `
                                <div class="quote-card">
                                    <div class="quote-card-header">
                                        <div>
                                            <strong style="color: white;">${quote.fabricatorName}</strong>
                                            <div style="color: var(--light-gray);">${utils.formatCurrency(quote.amount)} • ${quote.leadTime} dias</div>
                                            ${quote.pdfUrl ? `
                                            <a href="${quote.pdfUrl}" target="_blank" class="quote-pdf-link">
                                                <i class="fas fa-file-pdf"></i> Ver PDF do Orçamento
                                            </a>
                                            ` : ''}
                                        </div>
                                        <div>
                                            ${quote.status === 'accepted' ? 
                                                '<span class="status-badge status-completed">Aceito</span>' : 
                                                '<span class="status-badge status-pending">Pendente</span>'
                                            }
                                        </div>
                                    </div>
                                    <p style="color: var(--light-gray);">Enviado em ${utils.formatDate(quote.date)}</p>
                                    ${quote.notes ? `<p style="color: var(--light-gray);"><strong>Observações:</strong> ${quote.notes}</p>` : ''}
                                    ${AppState.currentUser.id === project.clientId && quote.status === 'pending' ? `
                                    <div class="quote-card-actions">
                                        <button class="btn btn-small btn-primary accept-quote-btn" data-quote-id="${quote.id}" data-project-id="${project.id}" data-fabricator-id="${quote.fabricatorId}">Aceitar Orçamento</button>
                                        <button class="btn btn-small btn-outline reject-quote-btn" data-quote-id="${quote.id}" data-project-id="${project.id}">Rejeitar</button>
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
                
                if (isRequest && project.fileUrl) {
                    modalFooter.innerHTML = `
                        <button type="button" class="btn btn-secondary" id="modal-download-btn">
                            <i class="fas fa-download"></i> Download do Projeto
                        </button>
                        <button type="button" class="btn btn-outline close-modal">Fechar</button>
                    `;
                    
                    document.getElementById('modal-download-btn').addEventListener('click', () => {
                        app.downloadProjectFile(project.fileUrl, project.fileName);
                    });
                    
                    modalFooter.querySelector('.close-modal').addEventListener('click', utils.closeAllModals);
                } else {
                    modalFooter.innerHTML = `
                        <button type="button" class="btn btn-outline close-modal">Fechar</button>
                    `;
                    modalFooter.querySelector('.close-modal').addEventListener('click', utils.closeAllModals);
                }
                
                modalContent.querySelectorAll('.accept-quote-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const quoteId = e.target.getAttribute('data-quote-id');
                        const projectId = e.target.getAttribute('data-project-id');
                        const fabricatorId = e.target.getAttribute('data-fabricator-id');
                        app.acceptQuote(projectId, quoteId, fabricatorId);
                    });
                });
                
                modalContent.querySelectorAll('.reject-quote-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const quoteId = e.target.getAttribute('data-quote-id');
                        const projectId = e.target.getAttribute('data-project-id');
                        app.rejectQuote(projectId, quoteId);
                    });
                });
                
                utils.openModal('project-detail-modal');
            },
            
            openQuoteDetailModal: async (projectId) => {
                console.log('Abrindo modal de orçamentos para projeto:', projectId);
                
                let project = AppState.projects.find(p => p.id === projectId);
                
                if (!project) {
                    utils.showNotification('Projeto não encontrado.', 'error');
                    return;
                }
                
                try {
                    const { data: quotes, error } = await supabaseClient
                        .from('quotes')
                        .select('*')
                        .eq('project_id', projectId)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    project.quotes = [];
                    for (let quote of quotes) {
                        const { data: fabricatorProfile } = await supabaseClient
                            .from('profiles')
                            .select('name')
                            .eq('id', quote.fabricator_id)
                            .single();
                        
                        project.quotes.push({
                            id: quote.id,
                            fabricatorId: quote.fabricator_id,
                            fabricatorName: fabricatorProfile?.name || 'Fabricante',
                            amount: parseFloat(quote.amount),
                            leadTime: quote.lead_time,
                            date: quote.created_at.split('T')[0],
                            status: quote.status,
                            pdfUrl: quote.pdf_url || null,
                            pdfFileName: quote.pdf_file_name || null,
                            notes: quote.notes,
                            paymentTerms: quote.payment_terms
                        });
                    }
                } catch (error) {
                    console.error('Erro ao carregar orçamentos:', error);
                }
                
                const modalContent = document.getElementById('quote-detail-content');
                
                if (!project.quotes || project.quotes.length === 0) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--light-gray);">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            <p>Nenhum orçamento recebido para este projeto ainda.</p>
                            <p style="font-size: 0.9rem;">Os fabricantes têm até 48 horas para enviar orçamentos.</p>
                        </div>
                    `;
                } else {
                    modalContent.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: white;">${project.name}</h3>
                            <p style="color: var(--light-gray);">Você recebeu ${project.quotes.length} orçamento${project.quotes.length > 1 ? 's' : ''} para este projeto.</p>
                        </div>
                        
                        ${project.quotes.map(quote => `
                            <div class="quote-card" style="margin-bottom: 15px;">
                                <div class="quote-card-header">
                                    <div>
                                        <strong style="color: white;">${quote.fabricatorName}</strong>
                                        <div style="display: flex; gap: 15px; margin-top: 5px;">
                                            <span style="color: var(--light-gray);"><i class="fas fa-dollar-sign"></i> ${utils.formatCurrency(quote.amount)}</span>
                                            <span style="color: var(--light-gray);"><i class="far fa-clock"></i> ${quote.leadTime} dias</span>
                                            <span style="color: var(--light-gray);"><i class="far fa-calendar"></i> ${utils.formatDate(quote.date)}</span>
                                        </div>
                                        ${quote.pdfUrl ? `
                                        <a href="${quote.pdfUrl}" target="_blank" class="quote-pdf-link">
                                            <i class="fas fa-file-pdf"></i> Ver PDF do Orçamento
                                        </a>
                                        ` : ''}
                                    </div>
                                    <div>
                                        ${quote.status === 'accepted' ? 
                                            '<span class="status-badge status-completed">Aceito</span>' : 
                                            quote.status === 'rejected' ?
                                            '<span class="status-badge status-cancelled">Rejeitado</span>' :
                                            '<span class="status-badge status-pending">Pendente</span>'
                                        }
                                    </div>
                                </div>
                                
                                ${quote.notes ? `<p style="color: var(--light-gray);"><strong>Observações:</strong> ${quote.notes}</p>` : ''}
                                
                                ${quote.status === 'pending' && AppState.currentUser.id === project.clientId ? `
                                <div class="quote-card-actions">
                                    <button class="btn btn-small btn-primary accept-quote-btn" data-quote-id="${quote.id}" data-project-id="${project.id}" data-fabricator-id="${quote.fabricatorId}">Aceitar Orçamento</button>
                                    <button class="btn btn-small btn-outline reject-quote-btn" data-quote-id="${quote.id}" data-project-id="${project.id}">Rejeitar</button>
                                </div>
                                ` : ''}
                                
                                ${quote.status === 'accepted' ? `
                                <div class="quote-card-actions">
                                    <button class="btn btn-small btn-accent open-chat-btn" data-project-id="${project.id}">
                                        <i class="fas fa-comments"></i> Chat com ${quote.fabricatorName}
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    `;
                }
                
                setTimeout(() => {
                    modalContent.querySelectorAll('.accept-quote-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const quoteId = e.target.getAttribute('data-quote-id');
                            const projectId = e.target.getAttribute('data-project-id');
                            const fabricatorId = e.target.getAttribute('data-fabricator-id');
                            app.acceptQuote(projectId, quoteId, fabricatorId);
                        });
                    });
                    
                    modalContent.querySelectorAll('.reject-quote-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const quoteId = e.target.getAttribute('data-quote-id');
                            const projectId = e.target.getAttribute('data-project-id');
                            app.rejectQuote(projectId, quoteId);
                        });
                    });
                    
                    modalContent.querySelectorAll('.open-chat-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const projectId = e.target.getAttribute('data-project-id');
                            app.openChatModal(projectId);
                        });
                    });
                }, 100);
                
                utils.openModal('quote-detail-modal');
            },
            
            rejectQuote: async (projectId, quoteId) => {
                if (confirm('Tem certeza que deseja rejeitar este orçamento?')) {
                    try {
                        const { error: quoteError } = await supabaseClient
                            .from('quotes')
                            .update({ 
                                status: 'rejected',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', quoteId);
                        
                        if (quoteError) throw quoteError;
                        
                        const { data: pendingQuotes, error: pendingError } = await supabaseClient
                            .from('quotes')
                            .select('id')
                            .eq('project_id', projectId)
                            .eq('status', 'pending');
                        
                        if (pendingError) {
                            console.error('Erro ao verificar cotações pendentes:', pendingError);
                        }
                        
                        if (!pendingQuotes || pendingQuotes.length === 0) {
                            const { error: projectError } = await supabaseClient
                                .from('projects')
                                .update({ 
                                    status: 'pending',
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', projectId);
                            
                            if (projectError) {
                                console.error('Erro ao atualizar projeto:', projectError);
                            }
                        }
                        
                        const project = AppState.projects.find(p => p.id === projectId);
                        if (project) {
                            const quote = project.quotes.find(q => q.id === quoteId);
                            if (quote) {
                                quote.status = 'rejected';
                            }
                            
                            const hasPendingQuotes = project.quotes.some(q => q.status === 'pending');
                            if (!hasPendingQuotes) {
                                project.status = 'pending';
                            }
                        }
                        
                        const fabricatorQuote = AppState.fabricatorQuotes.find(q => q.id === quoteId);
                        if (fabricatorQuote) {
                            fabricatorQuote.status = 'rejected';
                        }
                        
                        utils.showNotification('Orçamento rejeitado.', 'success');
                        
                        app.openQuoteDetailModal(projectId);
                        
                    } catch (error) {
                        console.error('Erro ao rejeitar orçamento:', error);
                        utils.showNotification('Erro ao rejeitar orçamento.', 'error');
                    }
                }
            },
            
            openFabricatorQuoteDetailModal: (quoteId) => {
                const quote = AppState.fabricatorQuotes.find(q => q.id === quoteId);
                if (!quote) return;
                
                const modalContent = document.getElementById('quote-detail-content');
                
                modalContent.innerHTML = `
                    <div class="card" style="box-shadow: none; border: none; padding: 0;">
                        <div class="card-header" style="border: none; padding: 0 0 20px 0;">
                            <div class="card-title">
                                <h3>${quote.projectName}</h3>
                                <p style="color: var(--light-gray);">Orçamento enviado para ${quote.clientName}</p>
                            </div>
                        </div>
                        
                        <div class="card-details">
                            <div class="detail-item">
                                <span class="detail-label">Valor do Orçamento</span>
                                <span class="detail-value">${utils.formatCurrency(quote.amount)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Prazo de Entrega</span>
                                <span class="detail-value">${quote.leadTime} dias</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Data de Envio</span>
                                <span class="detail-value">${utils.formatDate(quote.date)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Status</span>
                                <span class="detail-value">${utils.getStatusBadge(quote.status)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Condições de Pagamento</span>
                                <span class="detail-value">${quote.paymentTerms || 'Não especificado'}</span>
                            </div>
                            ${quote.pdfUrl ? `
                            <div class="detail-item">
                                <span class="detail-label">PDF Anexado</span>
                                <span class="detail-value">
                                    <a href="${quote.pdfUrl}" target="_blank" class="quote-pdf-link">
                                        <i class="fas fa-file-pdf"></i> ${quote.pdfFileName || 'Ver PDF'}
                                    </a>
                                </span>
                            </div>
                            ` : ''}
                        </div>
                        
                        ${quote.notes ? `
                        <div style="margin-top: 20px;">
                            <h4 style="color: white;">Observações</h4>
                            <p style="color: var(--light-gray);">${quote.notes}</p>
                        </div>
                        ` : ''}
                        
                        ${quote.status === 'pending' ? `
                        <div class="card-actions" style="margin-top: 20px;">
                            <button class="btn btn-small btn-outline" id="withdraw-quote" data-id="${quote.id}">Retirar Orçamento</button>
                            <button class="btn btn-small btn-primary" id="revise-quote" data-id="${quote.id}">Revisar Orçamento</button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                if (quote.status === 'pending') {
                    modalContent.querySelector('#withdraw-quote').addEventListener('click', (e) => {
                        const quoteId = e.target.getAttribute('data-id');
                        app.withdrawQuote(quoteId);
                    });
                    
                    modalContent.querySelector('#revise-quote').addEventListener('click', (e) => {
                        const quoteId = e.target.getAttribute('data-id');
                        app.reviseQuote(quoteId);
                    });
                }
                
                utils.openModal('quote-detail-modal');
            },
            
            openMethodDetailModal: (method) => {
                const methodDetails = {
                    'cnc-machining': {
                        title: 'Usinagem CNC',
                        description: 'Usinagem CNC (Controle Numérico Computadorizado) é um processo de fabricação no qual software de computador pré-programado dita o movimento das ferramentas e maquinário da fábrica.',
                        details: `
                            <p style="color: var(--light-gray);"><strong>Capacidades:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Fresamento 3, 4 e 5 eixos</li>
                                <li>Trabalho de torno e torneamento</li>
                                <li>Geometrias e contornos complexos</li>
                                <li>Tolerâncias apertadas (±0,001" / 0,025mm)</li>
                                <li>Ampla gama de materiais</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Aplicações Comuns:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Componentes de precisão</li>
                                <li>Peças de motor</li>
                                <li>Ferramental e moldes</li>
                                <li>Protipos e peças de uso final</li>
                                <li>Montagens complexas</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Prazo de Entrega Típico:</strong> 1-3 semanas</p>
                            <p style="color: var(--light-gray);"><strong>Melhor Para:</strong> Peças de alta precisão, componentes metálicos, geometrias complexas</p>
                        `
                    },
                    'laser-cutting': {
                        title: 'Corte a Laser',
                        description: 'O corte a laser usa um laser de alta potência para cortar materiais com extrema precisão, criando bordas limpas com zonas termicamente afetadas mínimas.',
                        details: `
                            <p style="color: var(--light-gray);"><strong>Capacidades:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Chapa metálica até 1" de espessura</li>
                                <li>Designs e padrões intrincados</li>
                                <li>Entrega rápida para peças planas</li>
                                <li>Múltiplos materiais (metais, plásticos, madeira)</li>
                                <li>Alta precisão (±0,005" / 0,127mm)</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Aplicações Comuns:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Componentes de chapa metálica</li>
                                <li>Painéis decorativos</li>
                                <li>Sinalização e displays</li>
                                <li>Proteções e invólucros de máquinas</li>
                                <li>Elementos arquitetônicos</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Prazo de Entrega Típico:</strong> 3-10 dias</p>
                            <p style="color: var(--light-gray);"><strong>Melhor Para:</strong> Peças planas, chapa metálica, recortes intrincados</p>
                        `
                    },
                    '3d-printing': {
                        title: 'Impressão 3D',
                        description: 'Manufatura aditiva que constrói peças camada por camada a partir de modelos digitais, ideal para geometrias complexas e prototipagem rápida.',
                        details: `
                            <p style="color: var(--light-gray);"><strong>Tecnologias Disponíveis:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>FDM (Modelagem por Fusão e Deposição)</li>
                                <li>SLA (Estereolitografia)</li>
                                <li>SLS (Sinterização Seletiva a Laser</li>
                                <li>Impressão 3D em Metal</li>
                                <li>Impressão multi-material</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Aplicações Comuns:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Prototipagem rápida</li>
                                <li>Gabinetes e suportes personalizados</li>
                                <li>Estruturas internas complexas</li>
                                <li>Produção de baixo volume</li>
                                <li>Peças médicas e dentárias</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Prazo de Entrega Típico:</strong> 2-7 dias</p>
                            <p style="color: var(--light-gray);"><strong>Melhor Para:</strong> Protótipos, geometrias complexas, peças personalizadas</p>
                        `
                    },
                    'prototyping': {
                        title: 'Prototipagem',
                        description: 'Serviços de prototipagem rápida para criar rapidamente modelos físicos para validação de design, testes e apresentação.',
                        details: `
                            <p style="color: var(--light-gray);"><strong>Serviços Oferecidos:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Modelos conceituais</li>
                                <li>Protipos funcionais</li>
                                <li>Validação de design</li>
                                <li>Amostras para testes de usuário</li>
                                <li>Desenvolvimento iterativo</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Aplicações Comuns:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Desenvolvimento de produto</li>
                                <li>Verificação de design</li>
                                <li>Apresentações para investidores</li>
                                <li>Testes de mercado</li>
                                <li>Campanhas de crowdfunding</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Prazo de Entrega Típico:</strong> 3-14 dias</p>
                            <p style="color: var(--light-gray);"><strong>Melhor Para:</strong> Desenvolvimento de novos produtos, validação de design</p>
                        `
                    },
                    'wood-fabrication': {
                        title: 'Fabricação em Madeira',
                        description: 'Serviços de marcenaria e carpintaria personalizados para móveis, elementos arquitetônicos e peças decorativas.',
                        details: `
                            <p style="color: var(--light-gray);"><strong>Capacidades:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Roteamento CNC em madeira</li>
                                <li>Móveis personalizados</li>
                                <li>Marcenaria arquitetônica</li>
                                <li>Juntas (cauda de andorinha, espiga e entalhe)</li>
                                <li>Acabamento e tingimento</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Aplicações Comuns:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Móveis personalizados</li>
                                <li>Armários e embutidos</li>
                                <li>Detalhes arquitetônicos</li>
                                <li>Sinalização e displays</li>
                                <li>Arte e esculturas</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Prazo de Entrega Típico:</strong> 2-4 semanas</p>
                            <p style="color: var(--light-gray);"><strong>Melhor Para:</strong> Móveis, marcenaria arquitetônica, peças personalizadas</p>
                        `
                    },
                    'welding': {
                        title: 'Soldagem e Fabricação',
                        description: 'Serviços de fabricação e soldagem metálica para componentes estruturais, quadros e montagens personalizadas.',
                        details: `
                            <p style="color: var(--light-gray);"><strong>Processos Disponíveis:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Solda TIG (precisão)</li>
                                <li>Solda MIG (produção)</li>
                                <li>Solda com eletrodo revestido (pesada)</li>
                                <li>Corte a plasma</li>
                                <li>Dobra e conformação de metais</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Aplicações Comuns:</strong></p>
                            <ul style="color: var(--light-gray);">
                                <li>Aço estrutural</li>
                                <li>Quadros e racks personalizados</li>
                                <li>Montagens de tubos e tubulações</li>
                                <li>Proteções e invólucros de máquinas</li>
                                <li>Arte e escultura</li>
                            </ul>
                            
                            <p style="color: var(--light-gray);"><strong>Prazo de Entrega Típico:</strong> 1-3 semanas</p>
                            <p style="color: var(--light-gray);"><strong>Melhor Para:</strong> Componentes estruturais, quadros metálicos, montagens personalizadas</p>
                        `
                    }
                };
                
                const detail = methodDetails[method] || methodDetails['cnc-machining'];
                
                document.getElementById('method-detail-title').textContent = detail.title;
                document.getElementById('method-detail-content').innerHTML = `
                    <p style="color: var(--light-gray);">${detail.description}</p>
                    ${detail.details}
                `;
                
                // Botão "Procurar Projetos" removido – apenas o botão "Fechar" permanece no rodapé
                
                utils.openModal('method-detail-modal');
            },
            
            openCapabilitiesModal: () => {
                const caps = AppState.fabricatorCapabilities;
                
                document.querySelectorAll('#capabilities-form input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = caps.methods.includes(checkbox.value);
                });
                
                document.getElementById('cap-min-order').value = caps.minOrder;
                document.getElementById('cap-max-size').value = caps.maxSize;
                document.getElementById('cap-lead-time').value = caps.leadTime;
                document.getElementById('cap-materials').value = caps.materials;
                
                utils.openModal('capabilities-modal');
            },
            
            acceptQuote: async (projectId, quoteId, fabricatorId) => {
                if (confirm('Tem certeza que deseja aceitar este orçamento?')) {
                    try {
                        console.log('Aceitando orçamento:', { projectId, quoteId, fabricatorId });
                        
                        const { error: quoteError } = await supabaseClient
                            .from('quotes')
                            .update({ 
                                status: 'accepted',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', quoteId);
                        
                        if (quoteError) throw new Error(`Erro ao atualizar orçamento: ${quoteError.message}`);
                        
                        console.log('Cotação atualizada para accepted no Supabase');
                        
                        const { error: rejectOtherQuotesError } = await supabaseClient
                            .from('quotes')
                            .update({ 
                                status: 'rejected',
                                updated_at: new Date().toISOString()
                            })
                            .eq('project_id', projectId)
                            .neq('id', quoteId);
                        
                        if (rejectOtherQuotesError) {
                            console.error('Erro ao rejeitar outras cotações:', rejectOtherQuotesError);
                        }
                        
                        const { error: projectError } = await supabaseClient
                            .from('projects')
                            .update({ 
                                status: 'in-progress',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', projectId);
                        
                        if (projectError) throw new Error(`Erro ao atualizar projeto: ${projectError.message}`);
                        
                        console.log('Projeto atualizado para in-progress no Supabase');
                        
                        const { data: existingJobs, error: jobsError } = await supabaseClient
                            .from('jobs')
                            .select('id')
                            .eq('project_id', projectId);
                        
                        if (jobsError) {
                            console.error('Erro ao verificar jobs existentes:', jobsError);
                        }
                        
                        let jobId = null;
                        
                        if (existingJobs && existingJobs.length > 0) {
                            const job = existingJobs[0];
                            jobId = job.id;
                            
                            const { error: updateJobError } = await supabaseClient
                                .from('jobs')
                                .update({
                                    quote_id: quoteId,
                                    fabricator_id: fabricatorId,
                                    status: 'in-progress',
                                    progress: 10,
                                    start_date: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', jobId);
                            
                            if (updateJobError) {
                                console.error('Erro ao atualizar job existente:', updateJobError);
                            } else {
                                console.log('Job atualizado:', jobId);
                            }
                        }
                        
                        if (!jobId) {
                            const { data: newJob, error: insertError } = await supabaseClient
                                .from('jobs')
                                .insert([{
                                    project_id: projectId,
                                    quote_id: quoteId,
                                    fabricator_id: fabricatorId,
                                    client_id: AppState.currentUser.id,
                                    status: 'in-progress',
                                    progress: 10,
                                    start_date: new Date().toISOString(),
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                }])
                                .select()
                                .single();
                            
                            if (insertError) {
                                console.error('Erro ao criar job:', insertError);
                                throw new Error(`Erro ao criar trabalho: ${insertError.message}`);
                            } else {
                                jobId = newJob.id;
                                console.log('Novo job criado:', newJob);
                            }
                        }
                        
                        const project = AppState.projects.find(p => p.id === projectId);
                        if (project) {
                            project.status = 'in-progress';
                            project.selectedQuoteId = quoteId;
                            project.acceptedQuoteId = quoteId;
                            project.progress = 10;
                            
                            project.quotes.forEach(quote => {
                                if (quote.id === quoteId) {
                                    quote.status = 'accepted';
                                } else {
                                    quote.status = 'rejected';
                                }
                            });
                        }
                        
                        AppState.fabricatorQuotes.forEach(quote => {
                            if (quote.projectId === projectId) {
                                if (quote.id === quoteId) {
                                    quote.status = 'accepted';
                                } else {
                                    quote.status = 'rejected';
                                }
                            }
                        });
                        
                        try {
                            const projectName = project ? project.name : 'o projeto';
                            const welcomeMessage = `Olá! O orçamento para o projeto "${projectName}" foi aceito. Aguardo o início da fabricação.`;
                            
                            await supabaseClient
                                .from('messages')
                                .insert([{
                                    project_id: projectId,
                                    sender_id: AppState.currentUser.id,
                                    message: welcomeMessage,
                                    created_at: new Date().toISOString()
                                }]);
                            
                            console.log('Mensagem inicial enviada no chat');
                        } catch (msgError) {
                            console.error('Erro ao enviar mensagem inicial:', msgError);
                        }
                        
                        utils.closeAllModals();
                        utils.showNotification(`Orçamento aceito com sucesso! O fabricante será notificado.`, 'success');
                        
                        await loadClientProjectsFromSupabase();
                        await app.loadFabricatorQuotesFromSupabase();
                        await app.loadFabricatorJobs();
                        
                        app.updateUI();
                        
                    } catch (error) {
                        console.error('Erro detalhado ao aceitar orçamento:', error);
                        utils.showNotification(`Erro ao aceitar orçamento: ${error.message}`, 'error');
                    }
                }
            },
            
            cancelProject: async (projectId) => {
                if (confirm('Tem certeza que deseja cancelar este projeto?')) {
                    const project = AppState.projects.find(p => p.id === projectId);
                    if (project) {
                        try {
                            await supabaseClient
                                .from('projects')
                                .update({ status: 'cancelled' })
                                .eq('id', projectId);
                            
                            project.status = 'cancelled';
                            
                            const request = AppState.fabricatorRequests.find(r => 
                                r.name === project.name && r.clientId === project.clientId
                            );
                            if (request) {
                                request.status = 'cancelled';
                            }
                            
                            utils.showNotification(`Projeto "${project.name}" foi cancelado.`, 'success');
                            app.updateUI();
                            
                        } catch (error) {
                            console.error('Erro ao cancelar projeto:', error);
                            utils.showNotification('Erro ao cancelar projeto. Tente novamente.', 'error');
                        }
                    }
                }
            },
            
            withdrawQuote: async (quoteId) => {
                if (confirm('Tem certeza que deseja retirar este orçamento?')) {
                    const quote = AppState.fabricatorQuotes.find(q => q.id === quoteId);
                    if (quote) {
                        try {
                            await supabaseClient
                                .from('quotes')
                                .update({ status: 'rejected' })
                                .eq('id', quoteId);
                            
                            quote.status = 'rejected';
                            
                            const project = AppState.projects.find(p => p.id === quote.projectId);
                            if (project) {
                                const projectQuote = project.quotes.find(q => q.id === quoteId);
                                if (projectQuote) {
                                    projectQuote.status = 'rejected';
                                }
                                
                                const pendingQuotes = project.quotes.filter(q => q.status === 'pending');
                                if (pendingQuotes.length === 0) {
                                    project.status = 'pending';
                                }
                            }
                            
                            utils.closeAllModals();
                            utils.showNotification('Orçamento retirado com sucesso.', 'success');
                            app.updateUI();
                            
                        } catch (error) {
                            console.error('Erro ao retirar orçamento:', error);
                            utils.showNotification('Erro ao retirar orçamento. Tente novamente.', 'error');
                        }
                    }
                }
            },
            
            reviseQuote: (quoteId) => {
                const quote = AppState.fabricatorQuotes.find(q => q.id === quoteId);
                if (quote) {
                    const project = AppState.fabricatorRequests.find(r => 
                        r.name === quote.projectName && r.clientId === quote.clientId
                    );
                    
                    if (project) {
                        app.openQuoteModal(project);
                    }
                }
            },
            
            updateJobProgress: async (jobId) => {
                const job = AppState.fabricatorJobs.find(j => j.id === jobId);
                if (job) {
                    const newProgress = prompt(`Digite a nova porcentagem de progresso para "${job.projectName}":`, job.progress);
                    if (newProgress !== null) {
                        const progress = parseInt(newProgress);
                        if (!isNaN(progress) && progress >= 0 && progress <= 100) {
                            job.progress = progress;
                            
                            try {
                                await supabaseClient
                                    .from('jobs')
                                    .update({ progress: progress })
                                    .eq('id', jobId);
                                
                                const project = AppState.projects.find(p => p.id === job.projectId);
                                if (project) {
                                    project.progress = progress;
                                    
                                    await supabaseClient
                                        .from('projects')
                                        .update({ 
                                            updated_at: new Date().toISOString()
                                        })
                                        .eq('id', job.projectId);
                                }
                                
                                if (progress === 100) {
                                    job.status = 'completed';
                                    job.completedDate = new Date().toISOString().split('T')[0];
                                    
                                    const project = AppState.projects.find(p => p.id === job.projectId);
                                    if (project) {
                                        project.status = 'completed';
                                    }
                                    
                                    const quote = AppState.fabricatorQuotes.find(q => q.id === job.quoteId);
                                    if (quote) {
                                        quote.status = 'completed';
                                    }
                                    
                                    await supabaseClient
                                        .from('jobs')
                                        .update({ 
                                            status: 'completed',
                                            completed_at: new Date().toISOString()
                                        })
                                        .eq('id', jobId);
                                    
                                    await supabaseClient
                                        .from('projects')
                                        .update({ 
                                            status: 'completed',
                                            updated_at: new Date().toISOString()
                                        })
                                        .eq('id', job.projectId);
                                    
                                    await supabaseClient
                                        .from('quotes')
                                        .update({ 
                                            status: 'completed',
                                            updated_at: new Date().toISOString()
                                        })
                                        .eq('id', job.quoteId);
                                }
                                
                                utils.showNotification(`Progresso atualizado para ${progress}% em "${job.projectName}".`, 'success');
                                app.updateUI();
                            } catch (error) {
                                console.error('Erro ao atualizar progresso:', error);
                                utils.showNotification('Erro ao atualizar progresso no servidor.', 'error');
                            }
                        } else {
                            utils.showNotification('Por favor, digite uma porcentagem válida entre 0 e 100.', 'error');
                        }
                    }
                }
            },
            
            // ===== FUNÇÕES PARA O CHAT =====
            openChatModal: async (projectId) => {
                console.log('Abrindo chat para projeto:', projectId, 'Usuário:', AppState.currentUser);
                
                AppState.chatMessages = [];
                const chatContainer = document.getElementById('chat-messages');
                if (chatContainer) {
                    chatContainer.innerHTML = '<div class="chat-empty"><i class="fas fa-spinner fa-spin"></i><p>Carregando conversa...</p></div>';
                }
                
                let project = null;
                let acceptedQuote = null;
                
                if (AppState.currentUser.type === 'client') {
                    console.log('Cliente abrindo chat...');
                    
                    project = AppState.projects.find(p => p.id === projectId);
                    
                    if (!project) {
                        console.log('Projeto não encontrado no estado local, buscando no Supabase...');
                        
                        try {
                            const { data: projectData, error } = await supabaseClient
                                .from('projects')
                                .select('*')
                                .eq('id', projectId)
                                .single();
                                
                            if (error || !projectData) {
                                console.error('Projeto não encontrado no Supabase:', error);
                                utils.showNotification('Projeto não encontrado.', 'error');
                                return;
                            }
                            
                            project = {
                                id: projectData.id,
                                name: projectData.name,
                                clientId: projectData.client_id,
                                clientName: AppState.currentUser.name,
                                description: projectData.description,
                                status: projectData.status,
                                quotes: []
                            };
                            
                            const { data: quotes, error: quotesError } = await supabaseClient
                                .from('quotes')
                                .select('*')
                                .eq('project_id', projectId);
                            
                            if (!quotesError && quotes) {
                                for (let quote of quotes) {
                                    const { data: fabricatorProfile } = await supabaseClient
                                        .from('profiles')
                                        .select('name')
                                        .eq('id', quote.fabricator_id)
                                        .single();
                                        
                                    project.quotes.push({
                                        id: quote.id,
                                        fabricatorId: quote.fabricator_id,
                                        fabricatorName: fabricatorProfile?.name || 'Fabricante',
                                        status: quote.status
                                    });
                                }
                            }
                            
                            if (!AppState.projects.find(p => p.id === project.id)) {
                                AppState.projects.push(project);
                            }
                            
                        } catch (error) {
                            console.error('Erro ao carregar projeto:', error);
                            utils.showNotification('Erro ao carregar projeto.', 'error');
                            return;
                        }
                    }
                    
                    acceptedQuote = project.quotes.find(q => q.status === 'accepted');
                    
                    if (!acceptedQuote) {
                        console.log('Nenhum orçamento aceito encontrado para o projeto:', project);
                        utils.showNotification('O chat será liberado após aceitar um orçamento do fabricante.', 'warning');
                        return;
                    }
                    
                    console.log('Cliente pode acessar chat - Orçamento aceito encontrado:', acceptedQuote);
                    
                } else if (AppState.currentUser.type === 'fabricator') {
                    console.log('Fabricante abrindo chat...');
                    
                    const job = AppState.fabricatorJobs.find(j => j.projectId === projectId && j.fabricatorId === AppState.currentUser.id);
                    
                    if (!job) {
                        try {
                            const { data: jobData, error: jobError } = await supabaseClient
                                .from('jobs')
                                .select('*')
                                .eq('project_id', projectId)
                                .eq('fabricator_id', AppState.currentUser.id)
                                .single();
                                
                            if (jobError || !jobData) {
                                console.log('Fabricante não tem job ativo para este projeto:', jobError);
                                utils.showNotification('Você não tem um trabalho ativo para este projeto.', 'warning');
                                return;
                            }
                        } catch (error) {
                            console.error('Erro ao buscar job:', error);
                            utils.showNotification('Erro ao verificar trabalho.', 'error');
                            return;
                        }
                    }
                    
                    try {
                        const { data: projectData, error } = await supabaseClient
                            .from('projects')
                            .select('*')
                            .eq('id', projectId)
                            .single();
                            
                        if (error || !projectData) {
                            console.error('Projeto não encontrado no Supabase:', error);
                            utils.showNotification('Projeto não encontrado.', 'error');
                            return;
                        }
                        
                        const { data: clientProfile } = await supabaseClient
                            .from('profiles')
                            .select('name')
                            .eq('id', projectData.client_id)
                            .single();
                        
                        project = {
                            id: projectData.id,
                            name: projectData.name,
                            clientId: projectData.client_id,
                            clientName: clientProfile?.name || 'Cliente',
                            description: projectData.description,
                            status: projectData.status,
                            quotes: []
                        };
                        
                        const { data: quoteData } = await supabaseClient
                            .from('quotes')
                            .select('*')
                            .eq('project_id', projectId)
                            .eq('fabricator_id', AppState.currentUser.id)
                            .eq('status', 'accepted')
                            .single();
                            
                        if (quoteData) {
                            acceptedQuote = {
                                id: quoteData.id,
                                fabricatorId: AppState.currentUser.id,
                                fabricatorName: AppState.currentUser.name,
                                status: 'accepted'
                            };
                            
                            project.quotes.push(acceptedQuote);
                        }
                        
                        console.log('Projeto carregado para fabricante:', project);
                        
                    } catch (error) {
                        console.error('Erro ao carregar projeto do fabricante:', error);
                        utils.showNotification('Erro ao carregar informações do projeto.', 'error');
                        return;
                    }
                }
                
                if (!project) {
                    console.error('Projeto não encontrado após todas as tentativas');
                    utils.showNotification('Projeto não encontrado.', 'error');
                    return;
                }
                
                console.log('Tudo OK para abrir chat:', { project, acceptedQuote });
                
                AppState.currentChatProject = project;
                
                let otherPartyName = '';
                let otherPartyId = null;
                
                if (AppState.currentUser.type === 'client') {
                    if (acceptedQuote) {
                        otherPartyName = acceptedQuote.fabricatorName;
                        otherPartyId = acceptedQuote.fabricatorId;
                    } else {
                        otherPartyName = 'Fabricante';
                    }
                } else {
                    otherPartyName = project.clientName;
                    otherPartyId = project.clientId;
                }
                
                document.getElementById('chat-project-name').textContent = `Chat: ${project.name}`;
                document.getElementById('chat-with-name').textContent = `Conversando com: ${otherPartyName}`;
                document.getElementById('chat-project-info').textContent = `Projeto: ${project.name} | Status: ${project.status}`;
                
                await app.loadChatMessages(projectId);
                
                await app.markMessagesAsRead(projectId);
                
                if (AppState.currentUser.type === 'client') {
                    const clientProject = AppState.projects.find(p => p.id === projectId);
                    if (clientProject) {
                        clientProject.unreadMessages = 0;
                    }
                } else {
                    const fabricatorJob = AppState.fabricatorJobs.find(j => j.projectId === projectId);
                    if (fabricatorJob) {
                        fabricatorJob.unreadMessages = 0;
                    }
                }
                
                utils.openModal('chat-modal');
                
                setTimeout(() => {
                    const messageInput = document.getElementById('chat-message-input');
                    if (messageInput) {
                        messageInput.focus();
                    }
                    
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }, 100);
            },
            
            loadChatMessages: async (projectId) => {
                const container = document.getElementById('chat-messages');
                container.innerHTML = '<div class="chat-empty"><i class="fas fa-spinner fa-spin"></i><p>Carregando mensagens...</p></div>';
                
                try {
                    const { data: messages, error } = await supabaseClient
                        .from('messages')
                        .select('*')
                        .eq('project_id', projectId)
                        .order('created_at', { ascending: true });
                    
                    if (error) throw error;
                    
                    container.innerHTML = '';
                    
                    if (messages.length === 0) {
                        container.innerHTML = '<div class="chat-empty"><i class="fas fa-comments"></i><p>Nenhuma mensagem ainda. Inicie a conversa!</p></div>';
                        return;
                    }
                    
                    AppState.chatMessages = messages;
                    
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${message.sender_id === AppState.currentUser.id ? 'sent' : 'received'}`;
                        
                        let senderName = '';
                        if (message.sender_id === AppState.currentUser.id) {
                            senderName = 'Você';
                        } else {
                            const project = AppState.currentChatProject;
                            if (AppState.currentUser.type === 'client') {
                                const acceptedQuote = project.quotes.find(q => q.status === 'accepted');
                                senderName = acceptedQuote ? acceptedQuote.fabricatorName : 'Fabricante';
                            } else {
                                senderName = project.clientName;
                            }
                        }
                        
                        messageDiv.innerHTML = `
                            <div class="message-sender">${senderName}</div>
                            <div class="message-text">${message.message}</div>
                            <div class="message-time">${utils.formatDateTime(message.created_at)}</div>
                        `;
                        container.appendChild(messageDiv);
                    });
                    
                    container.scrollTop = container.scrollHeight;
                    
                } catch (error) {
                    console.error('Erro ao carregar mensagens:', error);
                    container.innerHTML = '<div class="chat-empty"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar mensagens.</p></div>';
                }
            },
            
            markMessagesAsRead: async (projectId) => {
                try {
                    await supabaseClient
                        .from('messages')
                        .update({ read: true })
                        .eq('project_id', projectId)
                        .eq('read', false)
                        .neq('sender_id', AppState.currentUser.id);
                    
                    const project = AppState.projects.find(p => p.id === projectId);
                    if (project) {
                        project.unreadMessages = 0;
                    }
                    
                    const job = AppState.fabricatorJobs.find(j => j.projectId === projectId);
                    if (job) {
                        job.unreadMessages = 0;
                    }
                    
                } catch (error) {
                    console.error('Erro ao marcar mensagens como lidas:', error);
                }
            },
            
            sendChatMessage: async () => {
                const messageInput = document.getElementById('chat-message-input');
                const message = messageInput.value.trim();
                const project = AppState.currentChatProject;
                
                if (!message || !project) return;
                
                try {
                    const { data, error } = await supabaseClient
                        .from('messages')
                        .insert([{
                            project_id: project.id,
                            sender_id: AppState.currentUser.id,
                            message: message,
                            read: false
                        }]);
                    
                    if (error) throw error;
                    
                    messageInput.value = '';
                    
                    await app.loadChatMessages(project.id);
                    
                    utils.showNotification('Mensagem enviada!', 'success');
                    
                } catch (error) {
                    console.error('Erro ao enviar mensagem:', error);
                    utils.showNotification('Erro ao enviar mensagem.', 'error');
                }
            }
        };

        // ==================== OUVINTES DE EVENTO DA JANELA ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                utils.closeAllModals();
            }
        });

        // Verificar sessão ao carregar
        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                try {
                    const { data: profile, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (error) throw error;
                    
                    currentUser = {
                        id: session.user.id,
                        name: profile?.name || session.user.email.split('@')[0],
                        email: session.user.email,
                        type: profile?.user_type || 'client'
                    };
                    
                    AppState.currentUser = currentUser;
                    localStorage.setItem('fabricatehub_user', JSON.stringify(currentUser));
                    showMarketplace();
                    
                } catch (error) {
                    console.error('Erro ao carregar perfil:', error);
                    const { data: newProfile, error: createError } = await supabaseClient
                        .from('profiles')
                        .insert([{
                            id: session.user.id,
                            name: session.user.email.split('@')[0],
                            user_type: 'client'
                        }])
                        .select()
                        .single();
                    
                    if (!createError && newProfile) {
                        currentUser = {
                            id: session.user.id,
                            name: newProfile.name,
                            email: session.user.email,
                            type: newProfile.user_type || 'client'
                        };
                        
                        AppState.currentUser = currentUser;
                        localStorage.setItem('fabricatehub_user', JSON.stringify(currentUser));
                        showMarketplace();
                    }
                }
            }
        });
    </script>
</body>
</html>
